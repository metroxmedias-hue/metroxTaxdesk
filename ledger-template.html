<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metrox TaxInvoo Ledger</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root {
      --ink: #1a1a22;
      --muted: rgba(26,26,34,0.6);
      --line: rgba(0,0,0,0.08);
      --bg: #f6f6fb;
      --panel: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Poppins', Arial, sans-serif;
      background: #f6f6fb;
      color: var(--ink);
      padding: 16px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .page {
      width: 210mm;
      height: 297mm;
      background: var(--panel);
      padding: 20mm 18mm;
      border: 1px solid var(--line);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      border-bottom: 1px solid var(--line);
      padding-bottom: 12px;
      margin-bottom: 16px;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .meta {
      font-size: 12px;
      color: var(--muted);
      display: grid;
      gap: 4px;
      text-align: right;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .summary .box {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 12px;
    }

    .summary strong { font-size: 14px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid var(--line);
      text-align: left;
    }

    th { color: var(--muted); font-weight: 600; }
    td.num { text-align: right; }

    .footer {
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
      text-align: right;
    }

    @media print {
      @page { size: A4; margin: 12mm; }
      body { background: white; padding: 0; display: block; }
      .page { border: none; height: auto; }
    }
  </style>
</head>
<body>
  <div class="page" id="ledger-root">
    <div class="header">
      <div>
        <h1>Ledger Statement</h1>
        <div id="ledger-entity" style="font-size:14px;margin-top:4px;">—</div>
      </div>
      <div class="meta">
        <div>Period: <span id="ledger-period">—</span></div>
        <div>Type: <span id="ledger-type">—</span></div>
      </div>
    </div>

    <div class="summary">
      <div class="box">
        Opening balance<br/>
        <strong id="ledger-opening">₹0</strong>
      </div>
      <div class="box">
        Closing balance<br/>
        <strong id="ledger-closing">₹0</strong>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Reference</th>
          <th>Description</th>
          <th class="num">Debit</th>
          <th class="num">Credit</th>
          <th class="num">Balance</th>
        </tr>
      </thead>
      <tbody id="ledger-rows"></tbody>
    </table>

    <div class="footer">Generated by Metrox TaxInvoo</div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const stored = localStorage.getItem('Metrox TaxInvoo_ledger_export');
    const data = stored ? JSON.parse(stored) : {};
    const fmt = new Intl.NumberFormat('en-IN');

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value || '—';
    }

    setText('ledger-entity', data.name || '—');
    setText('ledger-type', data.type || '—');
    setText('ledger-period', data.period || '—');
    setText('ledger-opening', `₹${fmt.format(data.opening || 0)}`);
    setText('ledger-closing', `₹${fmt.format(data.closing || 0)}`);

    const rows = document.getElementById('ledger-rows');
    const entries = data.entries || [];
    if (!entries.length) {
      rows.innerHTML = '<tr><td colspan="6">No ledger entries.</td></tr>';
    } else {
      rows.innerHTML = entries.map(e => `
        <tr>
          <td>${e.date}</td>
          <td>${e.ref}</td>
          <td>${e.desc}</td>
          <td class="num">${e.debit ? `₹${fmt.format(e.debit)}` : '—'}</td>
          <td class="num">${e.credit ? `₹${fmt.format(e.credit)}` : '—'}</td>
          <td class="num">₹${fmt.format(e.balance)}</td>
        </tr>
      `).join('');
    }

    async function downloadPdf() {
      const target = document.getElementById('ledger-root');
      if (!window.html2canvas || !window.jspdf) {
        alert('PDF library not loaded. Please check your internet connection.');
        return;
      }
      const canvas = await window.html2canvas(target, {
        scale: 2,
        backgroundColor: '#ffffff',
        width: target.offsetWidth,
        height: target.offsetHeight,
        windowWidth: target.scrollWidth,
        windowHeight: target.scrollHeight
      });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;
      const scale = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
      const renderW = imgWidth * scale;
      const renderH = imgHeight * scale;
      const x = (pageWidth - renderW) / 2;
      const y = (pageHeight - renderH) / 2;
      pdf.addImage(imgData, 'PNG', x, y, renderW, renderH);
      pdf.save(`Ledger-${data.name || 'Metrox'}.pdf`);
    }

    if (params.get('auto') === 'pdf') {
      setTimeout(downloadPdf, 500);
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</body>
</html>

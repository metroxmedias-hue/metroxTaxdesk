<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metrox Taxdesk — App Shell</title>
  <meta name="description" content="Metrox Taxdesk app shell with navigation, GST calculator, and invoice flow." />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

    :root {
      --bg: #0b0e18;
      --panel: #11162a;
      --panel-2: #0f1324;
      --line: rgba(255,255,255,0.08);
      --ink: #f2efe6;
      --muted: rgba(242,239,230,0.65);
      --accent: #f7b23b;
      --accent-2: #58d6c1;
      --accent-3: #ff6f61;
      --shadow: 0 24px 60px rgba(0,0,0,0.35);
    }

    body.light {
      --bg: #ffffff;
      --panel: #ffffff;
      --panel-2: #f6f4ef;
      --line: rgba(17,24,39,0.12);
      --ink: #0f172a;
      --muted: rgba(15,23,42,0.6);
      --shadow: 0 14px 30px rgba(15,23,42,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 600px at 0% -10%, rgba(88,214,193,0.12), transparent),
                  radial-gradient(900px 500px at 100% 10%, rgba(247,178,59,0.14), transparent),
                  linear-gradient(180deg, #0a0d16, #0b0f1c 55%, #0b0e18);
      min-height: 100vh;
    }

    body.light {
      background: #ffffff;
      background-image:
        radial-gradient(900px 420px at 0% -10%, rgba(247,178,59,0.14), transparent),
        radial-gradient(900px 420px at 100% 0%, rgba(88,214,193,0.12), transparent);
    }

    body.light .sidebar {
      background: rgba(255,255,255,0.9);
      border-right: 1px solid rgba(26,26,34,0.08);
    }

    body.light .topbar {
      background: rgba(255,255,255,0.9);
      border-bottom: 1px solid rgba(26,26,34,0.08);
    }

    body.light .panel,
    body.light .card,
    body.light .list-item,
    body.light .payment-item,
    body.light .summary {
      background: var(--panel);
      box-shadow: 0 14px 30px rgba(27,28,33,0.08);
    }

    body.light .nav-item {
      color: rgba(15,23,42,0.7);
    }

    body.light .nav-item.active {
      background: rgba(247,178,59,0.16);
      border-color: rgba(247,178,59,0.45);
      color: #8a5b00;
    }

    body.light .tag {
      color: #196a5c;
      border-color: rgba(25,106,92,0.25);
      background: rgba(88,214,193,0.16);
    }

    body.light .pill {
      color: #8a5b00;
      border-color: rgba(247,178,59,0.4);
      background: rgba(247,178,59,0.18);
    }

    body.light .items-table th {
      color: rgba(15,23,42,0.6);
    }

    body.light .list-item:hover {
      border-color: rgba(247,178,59,0.4);
      transform: translateY(-1px);
    }

    body.light .field input,
    body.light .field select,
    body.light .field textarea,
    body.light .items-table input {
      background: #ffffff;
      color: var(--ink);
      border-color: rgba(26,26,34,0.12);
    }

    body.light .btn {
      border-color: rgba(26,26,34,0.14);
      background: #ffffff;
      box-shadow: 0 10px 22px rgba(15,23,42,0.08);
    }

    body.light .btn.primary {
      color: #1a1407;
    }

    body.light .btn.ghost {
      background: transparent;
      box-shadow: none;
    }

    body.light .summary {
      background: #ffffff;
      border-color: rgba(17,24,39,0.1);
    }

    body.light .row {
      color: rgba(15,23,42,0.55);
      border-bottom-color: rgba(15,23,42,0.08);
    }

    body.light .step {
      background: #ffffff;
      border-color: rgba(15,23,42,0.12);
      color: rgba(15,23,42,0.7);
      box-shadow: 0 12px 26px rgba(15,23,42,0.08);
    }

    a { color: inherit; text-decoration: none; }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      padding: 24px 20px;
      border-right: 1px solid var(--line);
      background: rgba(10,12,22,0.75);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      margin-bottom: 28px;
    }

    .brand-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: conic-gradient(from 120deg, var(--accent), var(--accent-2), #7f9cff, var(--accent));
      display: grid;
      place-items: center;
      color: #0b0e18;
      font-weight: 700;
    }

    .nav-group {
      display: grid;
      gap: 8px;
    }

    .nav-item {
      padding: 12px 14px;
      border-radius: 12px;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      border: 1px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .nav-item:hover { border-color: var(--line); color: var(--ink); }

    .nav-item.active {
      background: rgba(247,178,59,0.12);
      border-color: rgba(247,178,59,0.4);
      color: #ffe3b0;
    }

    .sidebar-footer {
      margin-top: 24px;
      padding: 14px;
      border-radius: 14px;
      background: rgba(17,22,42,0.7);
      border: 1px solid var(--line);
      font-size: 13px;
      color: var(--muted);
    }

    .sidebar-footer a {
      color: #ffe3b0;
      text-decoration: underline;
    }

    #app-shell { display: grid; }

    .auth-wrap {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      gap: 20px;
    }
    .auth-header {
      display: flex;
      align-items: center;
      gap: 14px;
      font-weight: 700;
      font-size: 18px;
    }
    .auth-grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 18px;
    }
    .auth-card {
      background: rgba(12,16,30,0.7);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .auth-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .auth-tab {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
    }
    .auth-tab.active {
      background: rgba(247,178,59,0.14);
      border-color: rgba(247,178,59,0.4);
      color: #ffe3b0;
    }

    .main {
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 28px;
      border-bottom: 1px solid var(--line);
      background: rgba(11,14,24,0.8);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .topbar h1 {
      margin: 0;
      font-family: "Fraunces", serif;
      font-size: 28px;
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--ink);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      pointer-events: auto;
      position: relative;
      z-index: 2;
    }

    .btn.primary {
      background: var(--accent);
      color: #1a1407;
      border-color: transparent;
      box-shadow: 0 12px 30px rgba(247,178,59,0.35);
    }

    .content {
      padding: 28px;
      display: grid;
      gap: 24px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 10px;
    }

    .card h3 { margin: 0; font-size: 18px; }
    .card p { margin: 0; color: var(--muted); font-size: 14px; }

    .grid-2 {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 18px;
    }

    .panel {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 18px;
      display: grid;
      gap: 12px;
    }

    .panel h4 { margin: 0; font-size: 16px; }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.08);
      font-size: 14px;
      color: var(--muted);
      gap: 12px;
    }

    .row:last-child { border-bottom: none; }

    .tag {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(88,214,193,0.4);
      color: #b6f5ea;
      background: rgba(88,214,193,0.12);
    }

    .screen {
      display: none;
      animation: fadeUp 0.4s ease forwards;
    }

    .screen.active { display: block; }

    .placeholder {
      border: 1px dashed rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 20px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
      font-size: 14px;
    }

    .form {
      display: grid;
      gap: 14px;
    }

    .field {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .field input, .field select, .field textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0c111f;
      color: var(--ink);
      font-family: inherit;
      font-size: 14px;
    }

    .field textarea { min-height: 80px; resize: vertical; }

    .split {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .items-table th, .items-table td {
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 10px 8px;
      text-align: left;
    }

    .items-table th { color: var(--muted); font-weight: 500; }

    .items-table input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #0c111f;
      color: var(--ink);
      font-size: 13px;
    }

    .items-table .btn {
      padding: 6px 10px;
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #ffe7ba;
      background: rgba(247,178,59,0.12);
      border: 1px solid rgba(247,178,59,0.32);
      padding: 6px 10px;
      border-radius: 999px;
      width: fit-content;
    }

    .summary {
      display: grid;
      gap: 10px;
      background: #0e1425;
      border-radius: 16px;
      border: 1px solid var(--line);
      padding: 16px;
    }

    .summary .row { border-bottom: none; padding: 6px 0; }

    .muted { color: var(--muted); }

    .mini-select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0c111f;
      color: var(--ink);
      font-family: inherit;
      font-size: 12px;
    }

    .list-card {
      display: grid;
      gap: 12px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(12,16,30,0.6);
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .list-item:hover { border-color: rgba(247,178,59,0.4); transform: translateY(-1px); }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.2);
      color: #ffe3b0;
    }

    .empty-state {
      padding: 16px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.18);
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .customer-detail h5 {
      margin: 0;
      font-size: 16px;
    }

    .customer-detail .row strong { color: var(--ink); }

    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .status-pending { color: #ffd1b3; border-color: rgba(255,209,179,0.35); }
    .status-partial { color: #bde2ff; border-color: rgba(189,226,255,0.35); }
    .status-paid { color: #b9f7d4; border-color: rgba(185,247,212,0.35); }

    .btn.ghost { border-style: dashed; color: var(--muted); }

    .payment-list {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }

    .payment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(12,16,30,0.6);
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 13px;
      color: var(--muted);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(4,6,12,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 24px;
    }

    .modal-backdrop.active { display: flex; }

    .modal {
      width: min(520px, 100%);
      background: #0f1426;
      border-radius: 18px;
      border: 1px solid var(--line);
      padding: 20px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 12px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .export-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .wireframes-inline {
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: #f6f2e8;
      min-height: 640px;
    }

    .wireframes-inline iframe {
      width: 100%;
      height: 720px;
      border: none;
    }

    .hero {
      display: grid;
      gap: 12px;
      padding: 18px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: linear-gradient(140deg, rgba(88,214,193,0.12), rgba(247,178,59,0.08));
      box-shadow: var(--shadow);
    }

    .hero h2 {
      margin: 0;
      font-family: "Fraunces", serif;
      font-size: 26px;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .stepper {
      display: grid;
      gap: 10px;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(12,16,30,0.6);
      color: var(--muted);
      font-size: 14px;
    }

    .step strong { color: var(--ink); }

    .otp-inputs {
      display: grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 8px;
    }

    .otp-inputs input {
      text-align: center;
      font-size: 16px;
      padding: 12px 0;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: #0c111f;
      color: var(--ink);
    }

    .otp-status {
      font-size: 12px;
      color: var(--muted);
    }

    .voice-card {
      display: grid;
      gap: 12px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid rgba(88,214,193,0.4);
      background: rgba(88,214,193,0.08);
      position: relative;
      z-index: 1;
    }

    .ai-bubble {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(12,16,30,0.6);
      font-size: 13px;
      color: var(--muted);
    }

    .ai-bubble strong { color: var(--ink); }

    .chart-row {
      display: grid;
      grid-template-columns: 120px 1fr 70px;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(12,16,30,0.6);
      font-size: 12px;
      color: var(--muted);
    }

    .chart-bar {
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(88,214,193,0.9), rgba(247,178,59,0.9));
      width: 0;
    }

    .mic {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: rgba(88,214,193,0.2);
      border: 1px solid rgba(88,214,193,0.45);
      color: #b6f5ea;
      font-weight: 700;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; }
      .topbar { position: static; }
      .topbar { flex-direction: column; align-items: flex-start; gap: 12px; }
      .actions { width: 100%; flex-wrap: wrap; }
      .content { padding: 20px; }
      .sidebar { padding: 16px; }
      .cards { grid-template-columns: 1fr; }
      .grid-2 { grid-template-columns: 1fr; }
      .split { grid-template-columns: 1fr; }
      .items-table { display: block; width: 100%; overflow-x: auto; white-space: nowrap; }
      .items-table th, .items-table td { white-space: nowrap; }
      .list-item, .payment-item { flex-direction: column; align-items: flex-start; gap: 6px; }
      .modal { width: 100%; }
      .modal-backdrop { padding: 16px; }
      .wireframes-inline iframe { height: 820px; }
      .auth-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .topbar h1 { font-size: 22px; }
      .actions .btn { width: 100%; justify-content: center; }
      .panel, .card { padding: 14px; border-radius: 14px; }
      .summary { padding: 12px; }
      .chart-row { grid-template-columns: 1fr; }
      .chart-row span { text-align: left; }
      .chart-row .chart-bar { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app" id="app-shell">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-mark">EG</div>
        <div>
          <div>Metrox Taxdesk</div>
          <small style="color:var(--muted);font-size:12px;">AI-first billing</small>
        </div>
      </div>
      <div class="nav-group" id="nav">
        <div class="nav-item" data-screen="setup">Business Setup</div>
        <div class="nav-item" data-screen="ai-billing">AI Voice Billing</div>
        <div class="nav-item active" data-screen="dashboard">Dashboard</div>
        <div class="nav-item" data-screen="invoices">Invoices</div>
        <div class="nav-item" data-screen="purchases">Purchases</div>
        <div class="nav-item" data-screen="customers">Customers</div>
        <div class="nav-item" data-screen="expenses">Expenses</div>
        <div class="nav-item" data-screen="reports">GST Reports</div>
        <div class="nav-item" data-screen="settings">Settings</div>
        <div class="nav-item" data-screen="wireframes">Wireframes</div>
      </div>
      <div class="sidebar-footer">
        View Android MVP wireframes in-app or open
        <a href="wireframes.html" target="_blank" rel="noreferrer">wireframes.html</a>.
      </div>
    </aside>

    <div class="main">
      <div class="topbar">
        <h1 id="screen-title">Dashboard</h1>
        <div class="actions">
          <button class="btn">Invite Accountant</button>
          <button class="btn" id="theme-toggle">Light mode</button>
          <button class="btn" id="logout-btn">Logout</button>
          <button class="btn primary" id="new-invoice">New Invoice</button>
        </div>
      </div>

      <div class="content">
        <section class="screen" id="setup">
          <div class="grid-2">
            <div class="panel">
              <h4>Business Setup</h4>
              <form class="form" id="setup-form">
                <label class="field">Business name
                  <input type="text" name="bizName" placeholder="Metrox Taxdesk Demo" />
                </label>
                <div class="split">
                  <label class="field">GSTIN (optional)
                    <input type="text" name="bizGstin" placeholder="27ABCDE1234F1Z5" />
                  </label>
                  <label class="field">Business type
                    <select name="bizType">
                      <option value="goods">Goods</option>
                      <option value="services">Services</option>
                    </select>
                  </label>
                </div>
                <div class="split">
                  <label class="field">Default GST slab
                    <select name="bizSlab">
                      <option value="18">18%</option>
                      <option value="12">12%</option>
                      <option value="5">5%</option>
                      <option value="28">28%</option>
                      <option value="0">0%</option>
                    </select>
                  </label>
                  <label class="field">State
                    <input type="text" name="bizState" placeholder="Maharashtra" />
                  </label>
                </div>
                <label class="field">Business address
                  <input type="text" name="bizAddress" placeholder="Registered address" />
                </label>
                <button class="btn primary" type="submit">Save setup</button>
              </form>
            </div>
            <div class="panel">
              <h4>Setup checklist</h4>
              <div class="stepper">
                <div class="step"><strong>Logo & signature</strong> Upload in Settings</div>
                <div class="step"><strong>Invoice prefix</strong> EG-001 in Settings</div>
                <div class="step"><strong>Bank details</strong> Add for UPI/NEFT</div>
              </div>
              <div class="placeholder" style="margin-top:12px;">
                Your setup details are used to auto-fill invoices and GST reports.
              </div>
            </div>
          </div>
        </section>

        <section class="screen" id="ai-billing">
          <div class="grid-2">
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <h4>AI Voice-to-Invoice</h4>
                <span class="pill">Hindi + English</span>
              </div>
              <div class="voice-card">
                <div style="display:flex;gap:12px;align-items:center;">
                  <div class="mic">AI</div>
                  <div>
                    <strong>Say or type:</strong>
                    <div class="muted">"Create bill for Rahul, ₹5000, GST 18%"</div>
                  </div>
                </div>
                <textarea id="ai-command" class="btn" style="border-radius:12px;min-height:110px;" placeholder="Type voice command here..."></textarea>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                  <button class="btn primary" id="parse-command">Generate invoice</button>
                  <button class="btn" id="sample-command">Use sample</button>
                  <button class="btn" id="ai-mic-btn" type="button">Start voice</button>
                  <button class="btn" id="ai-stop-btn" type="button">Stop</button>
                </div>
                <div class="muted" id="ai-status">AI is ready.</div>
              </div>
              <div class="panel" style="margin-top:12px;">
                <h4 style="margin:0 0 8px 0;">AI Assistant</h4>
                <div id="ai-chat" class="list-card"></div>
                <div class="muted" style="margin-top:8px;font-size:12px;">
                  Tip: Speech recognition needs HTTPS or localhost in most browsers.
                </div>
              </div>
              <div class="summary" style="margin-top:12px;">
                <div class="row"><span>Detected customer</span><strong id="ai-customer">—</strong></div>
                <div class="row"><span>Detected amount</span><strong id="ai-amount">—</strong></div>
                <div class="row"><span>Detected GST</span><strong id="ai-gst">—</strong></div>
              </div>
            </div>
            <div class="panel">
              <h4>AI Billing Tips</h4>
              <div class="stepper">
                <div class="step"><strong>Auto-fill items</strong> Single item created for now.</div>
                <div class="step"><strong>GST check</strong> Suggests slab from your setup.</div>
                <div class="step"><strong>Error detection</strong> Prompts if values missing.</div>
              </div>
              <div class="placeholder" style="margin-top:12px;">
                This demo simulates the AI flow by parsing your command text and routing to invoice creation.
              </div>
            </div>
          </div>
          <div class="panel">
            <h4>AI JSON Output (Spec-Compliant)</h4>
            <pre id="ai-json" class="placeholder" style="white-space:pre-wrap;">{}</pre>
          </div>
        </section>
        <section class="screen active" id="dashboard">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
            <div>
              <h3 style="margin:0;">Monthly Dashboard</h3>
              <div class="muted" style="font-size:12px;">Quick view by month</div>
            </div>
            <select id="dashboard-month" class="mini-select"></select>
          </div>
          <div class="cards" style="margin-top:14px;">
            <div class="card">
              <span class="tag">Today</span>
              <h3 id="stat-today">₹0</h3>
              <p>Sales today</p>
            </div>
            <div class="card">
              <span class="tag">Month</span>
              <h3 id="stat-month">₹0</h3>
              <p>Revenue this month</p>
            </div>
            <div class="card">
              <span class="tag">GST</span>
              <h3 id="stat-gst">₹0</h3>
              <p>GST payable</p>
            </div>
          </div>
          <div class="grid-2">
            <div class="panel">
              <h4>Recent invoices</h4>
              <div id="recent-invoices" class="muted">No invoices yet.</div>
            </div>
            <div class="panel">
              <h4>Pending payments</h4>
              <div id="pending-payments" class="muted">No pending payments.</div>
            </div>
          </div>
        </section>

        <section class="screen" id="invoices">
          <div class="grid-2">
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <h4>Create invoice</h4>
                <span class="pill">AI-ready</span>
              </div>
              <form class="form" id="invoice-form">
                <div class="split">
                  <label class="field">Select customer
                    <select name="customerSelect" id="customer-select">
                      <option value="">New customer</option>
                    </select>
                  </label>
                  <label class="field">Invoice type
                    <select name="invoiceType">
                      <option value="gst">GST Invoice</option>
                      <option value="non-gst">Non-GST Invoice</option>
                    </select>
                  </label>
                </div>
                <div class="split">
                  <label class="field">Customer name
                    <input type="text" name="customer" placeholder="Rahul Textiles" required />
                  </label>
                  <label class="field">Customer GSTIN
                    <input type="text" name="customerGstin" placeholder="27ABCDE1234F1Z5" />
                  </label>
                </div>
                <div class="split">
                  <label class="field">Customer phone
                    <input type="text" name="customerPhone" placeholder="+91 90000 00000" />
                  </label>
                  <label class="field">Customer email
                    <input type="email" name="customerEmail" placeholder="customer@email.com" />
                  </label>
                </div>
                <div class="split">
                  <label class="field">Customer state
                    <select name="customerState" id="customer-state">
                      <option value="Jammu & Kashmir">Jammu & Kashmir</option>
                      <option value="Himachal Pradesh">Himachal Pradesh</option>
                      <option value="Punjab">Punjab</option>
                      <option value="Chandigarh">Chandigarh</option>
                      <option value="Uttarakhand">Uttarakhand</option>
                      <option value="Haryana">Haryana</option>
                      <option value="Delhi">Delhi</option>
                      <option value="Rajasthan">Rajasthan</option>
                      <option value="Uttar Pradesh">Uttar Pradesh</option>
                      <option value="Bihar">Bihar</option>
                      <option value="Sikkim">Sikkim</option>
                      <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                      <option value="Nagaland">Nagaland</option>
                      <option value="Manipur">Manipur</option>
                      <option value="Mizoram">Mizoram</option>
                      <option value="Tripura">Tripura</option>
                      <option value="Meghalaya">Meghalaya</option>
                      <option value="Assam">Assam</option>
                      <option value="West Bengal">West Bengal</option>
                      <option value="Jharkhand">Jharkhand</option>
                      <option value="Odisha">Odisha</option>
                      <option value="Chattisgarh">Chattisgarh</option>
                      <option value="Madhya Pradesh">Madhya Pradesh</option>
                      <option value="Gujarat">Gujarat</option>
                      <option value="Daman & Diu">Daman & Diu</option>
                      <option value="Dadra & Nagar Haveli">Dadra & Nagar Haveli</option>
                      <option value="Maharashtra" selected>Maharashtra</option>
                      <option value="Andhra Pradesh (Before Division)">Andhra Pradesh (Before Division)</option>
                      <option value="Karnataka">Karnataka</option>
                      <option value="Goa">Goa</option>
                      <option value="Lakshadweep">Lakshadweep</option>
                      <option value="Kerala">Kerala</option>
                      <option value="Tamil Nadu">Tamil Nadu</option>
                      <option value="Puducherry">Puducherry</option>
                      <option value="Andaman & Nicobar Islands">Andaman & Nicobar Islands</option>
                      <option value="Telangana">Telangana</option>
                      <option value="Andhra Pradesh (Newly Added)">Andhra Pradesh (Newly Added)</option>
                      <option value="Ladakh">Ladakh</option>
                    </select>
                  </label>
                </div>
                <label class="field">Customer address
                  <input type="text" name="customerAddress" placeholder="Full address" />
                </label>
                <div class="split">
                  <label class="field">Place of supply
                    <select name="supply">
                      <option value="intra">Intra-state (CGST/SGST)</option>
                      <option value="inter">Inter-state (IGST)</option>
                    </select>
                  </label>
                  <label class="field">GST slab
                    <select name="gstRate">
                      <option value="0">0%</option>
                      <option value="5">5%</option>
                      <option value="12">12%</option>
                      <option value="18" selected>18%</option>
                      <option value="28">28%</option>
                    </select>
                  </label>
                </div>
                <div>
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h5 style="margin:0;">Line items</h5>
                    <button type="button" class="btn" id="add-line-item" onclick="window.addLineItem && window.addLineItem()">Add item</button>
                  </div>
                  <table class="items-table" style="margin-top:10px;">
                    <thead>
                      <tr>
                        <th>Item/Service</th>
                        <th>HSN</th>
                        <th>SAC</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="line-items"></tbody>
                  </table>
                  <script>
                    (function () {
                      const tbody = document.getElementById('line-items');
                      const fmt = new Intl.NumberFormat('en-IN');
                      function calcTotalsFromRows() {
                        const form = document.getElementById('invoice-form');
                        const invoiceType = form?.invoiceType?.value || 'gst';
                        const supply = form?.supply?.value || 'intra';
                        const rate = Number(form?.gstRate?.value || 0);
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        const taxable = rows.reduce((sum, r) => {
                          const qty = Number(r.querySelector('[name="qty"]')?.value || 0) || 0;
                          const price = Number(r.querySelector('[name="price"]')?.value || 0) || 0;
                          return sum + ((qty || 1) * price);
                        }, 0);
                        let cgst = 0, sgst = 0, igst = 0;
                        let total = taxable;
                        if (invoiceType !== 'non-gst' && rate > 0) {
                          const tax = taxable * (rate / 100);
                          if (supply === 'inter') {
                            igst = tax;
                          } else {
                            cgst = tax / 2;
                            sgst = tax / 2;
                          }
                          total = taxable + tax;
                        }
                        const roundedTotal = Math.round(total);
                        const roundOff = roundedTotal - total;
                        const fmtNum = (n) => `₹${fmt.format(n)}`;
                        const prevTaxable = document.getElementById('prev-taxable');
                        const prevTotal = document.getElementById('prev-total');
                        const prevRound = document.getElementById('prev-roundoff');
                        const prevTax = document.getElementById('prev-tax');
                        const prevCgst = document.getElementById('prev-cgst');
                        const prevSgst = document.getElementById('prev-sgst');
                        const prevIgst = document.getElementById('prev-igst');
                        const breakup = document.getElementById('gst-breakup');
                        if (prevTaxable) prevTaxable.textContent = fmtNum(taxable);
                        if (prevTotal) prevTotal.textContent = fmtNum(roundedTotal);
                        if (prevRound) prevRound.textContent = fmtNum(roundOff);
                        if (invoiceType === 'non-gst' || rate === 0) {
                          if (prevTax) prevTax.textContent = fmtNum(0);
                          if (breakup) breakup.style.display = 'none';
                        } else if (supply === 'inter') {
                          if (prevTax) prevTax.textContent = fmtNum(igst);
                          if (prevIgst) prevIgst.textContent = fmtNum(igst);
                          if (breakup) breakup.style.display = 'none';
                        } else {
                          if (prevTax) prevTax.textContent = fmtNum(cgst + sgst);
                          if (prevCgst) prevCgst.textContent = fmtNum(cgst);
                          if (prevSgst) prevSgst.textContent = fmtNum(sgst);
                          if (prevIgst) prevIgst.textContent = fmtNum(0);
                          if (breakup) breakup.style.display = 'grid';
                        }
                      }

                      function wire(row) {
                        const removeBtn = row.querySelector('.remove-line');
                        if (removeBtn) removeBtn.addEventListener('click', () => row.remove());
                        row.querySelectorAll('input').forEach(input => {
                          input.addEventListener('input', () => {
                            const qty = Number(row.querySelector('[name="qty"]').value) || 0;
                            const price = Number(row.querySelector('[name="price"]').value) || 0;
                            row.querySelector('.line-total').textContent = `₹${fmt.format((qty || 1) * price)}`;
                            calcTotalsFromRows();
                          });
                        });
                      }
                      function makeRow() {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                          <td><input name="desc" value="Service" placeholder="Item or service" /></td>
                          <td><input name="hsn" value="" placeholder="HSN" /></td>
                          <td><input name="sac" value="" placeholder="SAC" /></td>
                          <td><input name="qty" type="number" min="1" step="1" value="1" /></td>
                          <td><input name="price" type="number" min="0" step="0.01" value="0" /></td>
                          <td class="line-total">₹0</td>
                          <td><button type="button" class="btn ghost remove-line">Remove</button></td>
                        `;
                        wire(row);
                        return row;
                      }
                      window.addLineItem = function () {
                        if (!tbody) return;
                        if (typeof window.createLineItemRow === 'function') {
                          tbody.appendChild(window.createLineItemRow());
                          if (typeof window.updateLineTotals === 'function') window.updateLineTotals();
                        } else {
                          tbody.appendChild(makeRow());
                        }
                        calcTotalsFromRows();
                      };
                      if (tbody && !tbody.children.length) {
                        if (typeof window.createLineItemRow === 'function') {
                          tbody.appendChild(window.createLineItemRow({ description: 'Service', qty: 1, price: 0 }));
                          if (typeof window.updateLineTotals === 'function') window.updateLineTotals();
                        } else {
                          tbody.appendChild(makeRow());
                        }
                        calcTotalsFromRows();
                      }
                    })();
                  </script>
                </div>
                <label class="field">Notes
                  <textarea name="notes" placeholder="Payment terms, thanks note, etc."></textarea>
                </label>
                <button type="button" class="btn primary" id="generate-invoice-btn">Generate Invoice</button>
              </form>
            </div>
            <div class="panel">
              <h4>Invoice preview</h4>
              <div class="summary" id="invoice-preview">
                <div class="row"><span>Invoice #</span><strong id="prev-id">EG-0000</strong></div>
                <div class="row"><span>Customer</span><strong id="prev-customer">—</strong></div>
                <div class="row"><span>Taxable value</span><strong id="prev-taxable">₹0</strong></div>
                <div class="row"><span id="prev-tax-label">GST</span><strong id="prev-tax">₹0</strong></div>
                <div class="row"><span>Round off</span><strong id="prev-roundoff">₹0</strong></div>
                <div class="row"><span>Total</span><strong id="prev-total">₹0</strong></div>
              </div>
              <div class="summary" id="gst-breakup" style="display:none;">
                <div class="row"><span>CGST</span><strong id="prev-cgst">₹0</strong></div>
                <div class="row"><span>SGST</span><strong id="prev-sgst">₹0</strong></div>
                <div class="row"><span>IGST</span><strong id="prev-igst">₹0</strong></div>
              </div>
            </div>
          </div>

          <div class="panel">
            <h4>Invoices list</h4>
            <table class="items-table" id="invoice-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>GST</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="7" class="muted">No invoices yet.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="panel">
            <h4>Download Invoices (A4 PDF)</h4>
            <div id="invoice-downloads" class="list-card"></div>
          </div>

        </section>

        <section class="screen" id="purchases">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h4>Purchase Entries</h4>
              <span class="pill">Input GST</span>
            </div>
            <form class="form" id="purchase-form">
              <div class="split">
                <label class="field">Supplier name
                  <input type="text" name="supplierName" placeholder="Ram Traders" required />
                </label>
                <label class="field">Purchase type
                  <select name="purchaseType">
                    <option value="goods">Goods</option>
                    <option value="services">Services</option>
                  </select>
                </label>
              </div>
              <div class="split">
                <label class="field">Place of supply
                  <select name="purchaseSupply">
                    <option value="intra">Intra-state (CGST/SGST)</option>
                    <option value="inter">Inter-state (IGST)</option>
                  </select>
                </label>
                <label class="field">GST slab
                  <select name="purchaseGstRate">
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="12">12%</option>
                    <option value="18" selected>18%</option>
                    <option value="28">28%</option>
                  </select>
                </label>
              </div>
              <div class="split">
                <label class="field">Item/Service
                  <input type="text" name="purchaseItem" placeholder="Inventory items" />
                </label>
                <label class="field">Amount (₹)
                  <input type="number" name="purchaseAmount" min="0" step="0.01" placeholder="12000" />
                </label>
              </div>
              <div class="split">
                <label class="field">Bill no (reference)
                  <input type="text" name="purchaseBillNo" placeholder="INV-REF-001" />
                </label>
                <label class="field">Bill date
                  <input type="date" name="purchaseDate" />
                </label>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="btn primary" type="submit">Add purchase</button>
                <button class="btn" type="button" id="export-purchases">Export CSV</button>
              </div>
            </form>
          </div>

          <div class="panel">
            <h4>Recent Purchases</h4>
            <div id="purchase-list" class="list-card"></div>
          </div>
        </section>

        <section class="screen" id="customers">
          <div class="grid-2">
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
                <h4>Customers</h4>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                  <input id="customer-search" class="btn" style="border-radius:12px;" placeholder="Search" />
                  <button class="btn primary" id="add-customer-btn">Add customer</button>
                </div>
              </div>
              <div id="customer-list" class="list-card"></div>
              <div id="add-customer-form" class="form" style="display:none;margin-top:12px;">
                <div class="split">
                  <label class="field">Customer name
                    <input type="text" id="new-cust-name" placeholder="Rahul Textiles" />
                  </label>
                  <label class="field">GSTIN
                    <input type="text" id="new-cust-gstin" placeholder="27ABCDE1234F1Z5" />
                  </label>
                </div>
                <div class="split">
                  <label class="field">Phone
                    <input type="text" id="new-cust-phone" placeholder="+91 90000 00000" />
                  </label>
                  <label class="field">Email
                    <input type="email" id="new-cust-email" placeholder="customer@email.com" />
                  </label>
                </div>
                <label class="field">Address
                  <input type="text" id="new-cust-address" placeholder="Full address" />
                </label>
                <label class="field">State
                  <input type="text" id="new-cust-state" placeholder="Maharashtra" />
                </label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                  <button class="btn primary" id="save-new-customer">Save customer</button>
                  <button class="btn" id="cancel-new-customer">Cancel</button>
                </div>
              </div>
            </div>
            <div class="panel customer-detail">
              <h4>Customer detail</h4>
              <div id="customer-detail" class="empty-state">Select a customer to view ledger.</div>
            </div>
          </div>
        </section>

        <section class="screen" id="expenses">
          <div class="grid-2">
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <h4>Smart Expenses</h4>
                <span class="pill">Premium</span>
              </div>
              <div class="panel" style="background:rgba(255,255,255,0.03);">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <h4>AI Receipt Scan</h4>
                  <span class="badge">Demo</span>
                </div>
                <div class="placeholder" style="display:grid;gap:10px;">
                  <div>Upload a receipt and we’ll auto‑fill amount, date, and category.</div>
                  <input type="file" id="receipt-upload" accept="image/*,application/pdf" class="btn" />
                  <div id="receipt-status" class="muted">Waiting for receipt.</div>
                  <button class="btn" id="receipt-fill" type="button">Auto‑fill from receipt</button>
                </div>
              </div>
              <form class="form" id="expense-form">
                <div class="split">
                  <label class="field">Expense name
                    <input type="text" name="expenseName" placeholder="Office rent" required />
                  </label>
                  <label class="field">Amount (₹)
                    <input type="number" name="expenseAmount" min="0" step="0.01" placeholder="12000" required />
                  </label>
                </div>
                <div class="split">
                  <label class="field">Category
                    <select name="expenseCategory">
                      <option value="Rent">Rent</option>
                      <option value="Travel">Travel</option>
                      <option value="Ads">Ads & Marketing</option>
                      <option value="Supplies">Supplies</option>
                      <option value="Utilities">Utilities</option>
                      <option value="Salaries">Salaries</option>
                      <option value="Other">Other</option>
                    </select>
                  </label>
                  <label class="field">Date
                    <input type="date" name="expenseDate" />
                  </label>
                </div>
                <label class="field">Notes
                  <input type="text" name="expenseNotes" placeholder="Paid via UPI" />
                </label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                  <button class="btn primary" type="submit">Add expense</button>
                  <button class="btn" type="button" id="expense-ai-tag">Auto-tag (demo)</button>
                </div>
              </form>
            </div>
            <div class="panel">
              <h4>Expense Insights</h4>
              <div class="summary">
                <div class="row"><span>This month</span><strong id="expense-month">₹0</strong></div>
                <div class="row"><span>Top category</span><strong id="expense-top">—</strong></div>
                <div class="row"><span>Cashflow risk</span><strong id="expense-risk">Low</strong></div>
              </div>
              <div class="placeholder" style="margin-top:12px;">
                Premium insight: "Your travel expenses are up 18% this month."
              </div>
              <div class="panel" style="margin-top:12px;">
                <h4>Expense Charts</h4>
                <div id="expense-chart" class="list-card"></div>
                <div class="muted" style="margin-top:8px;font-size:12px;">
                  Chart shows category spend for the current month.
                </div>
              </div>
            </div>
          </div>
          <div class="panel" style="margin-top:18px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <h4>Recent Expenses</h4>
              <button class="btn" id="export-expenses">Export CSV</button>
            </div>
            <div id="expense-list" class="list-card"></div>
          </div>
        </section>

        <section class="screen" id="reports">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
              <h4>GST Reports</h4>
              <select id="gst-month" class="mini-select"></select>
            </div>
            <div class="summary">
              <div class="row"><span>Total taxable</span><strong id="gst-taxable">₹0</strong></div>
              <div class="row"><span>Total GST</span><strong id="gst-total">₹0</strong></div>
              <div class="row"><span>Total invoices</span><strong id="gst-count">0</strong></div>
              <div class="row"><span>IGST share</span><strong id="gst-igst">0%</strong></div>
            </div>
            <div class="panel" style="background:rgba(255,255,255,0.03);">
              <h4>Monthly Snapshot</h4>
              <div class="summary">
                <div class="row"><span>Intra-state GST</span><strong id="gst-intra">₹0</strong></div>
                <div class="row"><span>Inter-state GST</span><strong id="gst-inter">₹0</strong></div>
                <div class="row"><span>Avg invoice</span><strong id="gst-avg">₹0</strong></div>
              </div>
            </div>
            <div class="panel" style="background:rgba(255,255,255,0.03);">
              <h4>Input GST (Purchases)</h4>
              <div class="summary">
                <div class="row"><span>Input CGST</span><strong id="gst-in-cgst">₹0</strong></div>
                <div class="row"><span>Input SGST</span><strong id="gst-in-sgst">₹0</strong></div>
                <div class="row"><span>Input IGST</span><strong id="gst-in-igst">₹0</strong></div>
                <div class="row"><span>Net GST payable</span><strong id="gst-net">₹0</strong></div>
              </div>
            </div>
            <div class="export-actions">
              <button class="btn" id="export-gst-pdf">Export PDF (stub)</button>
              <button class="btn" id="export-gst-excel">Export Excel (CSV)</button>
            </div>
          </div>
        </section>

        <section class="screen" id="settings">
          <div class="panel">
            <h4>Settings</h4>
            <form class="form" id="settings-form">
              <div class="split">
                <label class="field">Company name
                  <input type="text" name="companyName" placeholder="Metrox Media" />
                </label>
                <label class="field">Company GSTIN
                  <input type="text" name="companyGstin" placeholder="27FNAPB1301AZL" />
                </label>
              </div>
              <div class="split">
                <label class="field">Company email
                  <input type="email" name="companyEmail" placeholder="info@company.com" />
                </label>
                <label class="field">Company phone
                  <input type="text" name="companyPhone" placeholder="+91 90000 00000" />
                </label>
              </div>
              <label class="field">Company address
                <input type="text" name="companyAddress" placeholder="Registered office address" />
              </label>
              <label class="field">Company logo
                <input type="file" name="companyLogo" accept="image/*" />
              </label>
              <label class="field">Signature image
                <input type="file" name="companySignature" accept="image/*" />
              </label>
              <label class="field">QR code image
                <input type="file" name="companyQr" accept="image/*" />
              </label>
              <label class="field">Invoice footer text
                <input type="text" name="invoiceFooter" placeholder="Thank you for your business." />
              </label>
              <label class="field">Invoice font
                <select name="invoiceFont">
                  <option value="Poppins">Poppins</option>
                  <option value="Inter">Inter</option>
                  <option value="Space Grotesk">Space Grotesk</option>
                  <option value="Roboto Slab">Roboto Slab</option>
                </select>
              </label>
              <div class="split">
                <label class="field">Invoice prefix
                  <input type="text" name="invoicePrefix" placeholder="EG-" />
                </label>
                <label class="field">Next invoice number
                  <input type="text" name="invoiceNext" placeholder="001" />
                </label>
              </div>
              <label class="field">Invoice template style
                <select name="invoiceStyle">
                  <option value="modern">Modern</option>
                  <option value="classic">Classic</option>
                  <option value="minimal">Minimal</option>
                </select>
              </label>
              <label class="field">
                <input type="checkbox" name="watermarkPaid" />
                Show “PAID” watermark on paid invoices
              </label>
              <div class="panel" style="background:rgba(255,255,255,0.03);">
                <h4>Bank details</h4>
                <div class="split">
                  <label class="field">Bank name
                    <input type="text" name="bankName" />
                  </label>
                  <label class="field">Account no.
                    <input type="text" name="bankAccount" />
                  </label>
                </div>
                <div class="split">
                  <label class="field">IFSC
                    <input type="text" name="bankIfsc" />
                  </label>
                  <label class="field">Branch
                    <input type="text" name="bankBranch" />
                  </label>
                </div>
                <label class="field">UPI ID
                  <input type="text" name="bankUpi" />
                </label>
              </div>
              <button type="submit" class="btn primary">Save settings</button>
            </form>
          </div>
          <div class="panel">
            <h4>Restore Deleted Customers</h4>
            <div id="deleted-customers" class="list-card"></div>
          </div>
        </section>

        <section class="screen" id="wireframes">
          <div class="panel">
            <h4>Android MVP Wireframes</h4>
            <div class="wireframes-inline">
              <iframe title="Metrox Taxdesk wireframes" src="wireframes.html"></iframe>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="payment-modal">
    <div class="modal">
      <div class="modal-header">
        <strong id="payment-title">Record payment</strong>
        <button class="btn ghost" id="payment-close">Close</button>
      </div>
      <div class="summary">
        <div class="row"><span>Invoice</span><strong id="payment-invoice">—</strong></div>
        <div class="row"><span>Due</span><strong id="payment-due">₹0</strong></div>
      </div>
      <label class="field">Payment amount (₹)
        <input type="number" id="payment-amount" min="0" step="0.01" />
      </label>
      <button class="btn primary" id="payment-save">Save payment</button>
    </div>
  </div>

  <script>
    const fmt = new Intl.NumberFormat('en-IN');
    const state = {
      invoices: [],
      invoiceCounter: 2409,
      payments: [],
      expenses: [],
      purchases: [],
      customers: {},
      company: {
        name: 'Metrox Media',
        address: 'Registered Office: Modern Labour Comp Welfare Society, Sunder Nagar, Malad (W), Mumbai, Maharashtra - 400064',
        gstin: '27FNAPB1301AZL',
        type: 'services',
        defaultSlab: '18',
        state: 'Maharashtra',
        email: 'metroxmediaindia@gmail.com',
        phone: '+91 90000 00000',
        logo: '',
        signature: '',
        qr: '',
        footer: 'Thank you for your business.',
        font: 'Poppins',
        template: 'modern',
        watermarkPaid: true,
        invoiceNumber: {
          prefix: 'EG-',
          next: '001',
          pad: 3,
          start: '001'
        },
        bank: {
          name: 'State Bank of India',
          account: '0000000000',
          ifsc: 'SBIN000000',
          branch: 'Sunder Nagar',
          upi: 'metrox@upi'
        },
        theme: {
          accent: '#7d3cff',
          bg: '#111018',
          band: '#5218b8',
          text: '#f5f4ff'
        }
      }
    };

    const navItems = document.querySelectorAll('.nav-item');
    const screens = document.querySelectorAll('.screen');
    const title = document.getElementById('screen-title');
    const newInvoiceBtn = document.getElementById('new-invoice');
    function showScreen(targetId, labelOverride) {
      navItems.forEach((n) => n.classList.toggle('active', n.dataset.screen === targetId));
      screens.forEach((screen) => {
        screen.classList.toggle('active', screen.id === targetId);
      });
      const navLabel = labelOverride || (document.querySelector(`[data-screen="${targetId}"]`)?.textContent || 'Dashboard');
      title.textContent = navLabel;
    }

    navItems.forEach((item) => {
      item.addEventListener('click', () => {
        showScreen(item.dataset.screen, item.textContent);
      });
    });

    newInvoiceBtn.addEventListener('click', () => {
      showScreen('invoices', 'Invoices');
      document.getElementById('invoice-form').scrollIntoView({ behavior: 'smooth' });
    });

    const themeToggle = document.getElementById('theme-toggle');
    function applyTheme(isLight) {
      document.body.classList.toggle('light', isLight);
      if (themeToggle) themeToggle.textContent = isLight ? 'Dark mode' : 'Light mode';
      localStorage.setItem('Metrox Taxdesk_theme', isLight ? 'light' : 'dark');
    }
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        applyTheme(!document.body.classList.contains('light'));
      });
    }
    const savedTheme = localStorage.getItem('Metrox Taxdesk_theme');
    if (savedTheme === 'light') applyTheme(true);

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        alert('Login flow is disabled in this demo.');
      });
    }

    const customerSearch = document.getElementById('customer-search');
    if (customerSearch) {
      customerSearch.addEventListener('input', renderCustomers);
    }

    const setupForm = document.getElementById('setup-form');
    if (setupForm) {
      const applySetupForm = () => {
        setupForm.bizName.value = state.company.name || '';
        setupForm.bizGstin.value = state.company.gstin || '';
        setupForm.bizType.value = state.company.type || 'services';
        setupForm.bizSlab.value = state.company.defaultSlab || '18';
        setupForm.bizAddress.value = state.company.address || '';
        setupForm.bizState.value = state.company.state || '';
      };
      applySetupForm();

      setupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        state.company.name = setupForm.bizName.value.trim() || state.company.name;
        state.company.gstin = setupForm.bizGstin.value.trim();
        state.company.type = setupForm.bizType.value;
        state.company.defaultSlab = setupForm.bizSlab.value;
        state.company.address = setupForm.bizAddress.value.trim();
        state.company.state = setupForm.bizState.value.trim();
        saveState();
        alert('Business setup saved.');
        showScreen('dashboard', 'Dashboard');
      });
    }

    const expenseForm = document.getElementById('expense-form');
    const expenseList = document.getElementById('expense-list');
    const expenseMonth = document.getElementById('expense-month');
    const expenseTop = document.getElementById('expense-top');
    const expenseRisk = document.getElementById('expense-risk');
    const expenseAiTag = document.getElementById('expense-ai-tag');
    const exportExpensesBtn = document.getElementById('export-expenses');
    const receiptUpload = document.getElementById('receipt-upload');
    const receiptStatus = document.getElementById('receipt-status');
    const receiptFill = document.getElementById('receipt-fill');
    let lastReceiptName = '';
    const expenseChart = document.getElementById('expense-chart');

    function renderExpenses() {
      if (!expenseList) return;
      if (!state.expenses.length) {
        expenseList.innerHTML = '<div class="empty-state">No expenses yet.</div>';
        if (expenseMonth) expenseMonth.textContent = '₹0';
        if (expenseTop) expenseTop.textContent = '—';
        if (expenseRisk) expenseRisk.textContent = 'Low';
        if (expenseChart) expenseChart.innerHTML = '<div class="empty-state">No chart data yet.</div>';
        return;
      }
      expenseList.innerHTML = state.expenses.slice().reverse().map(exp => `
        <div class="list-item">
          <div>
            <strong>${exp.name}</strong><br/>
            <span class="muted">${exp.category} • ${exp.date}</span>
          </div>
          <strong>₹${fmt.format(exp.amount)}</strong>
        </div>
      `).join('');

      const now = new Date();
      const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthTotal = state.expenses
        .filter(exp => exp.date.startsWith(monthKey))
        .reduce((sum, exp) => sum + exp.amount, 0);
      if (expenseMonth) expenseMonth.textContent = `₹${fmt.format(monthTotal)}`;

      const byCategory = {};
      state.expenses.forEach(exp => {
        byCategory[exp.category] = (byCategory[exp.category] || 0) + exp.amount;
      });
      const top = Object.entries(byCategory).sort((a, b) => b[1] - a[1])[0];
      if (expenseTop) expenseTop.textContent = top ? top[0] : '—';
      if (expenseRisk) expenseRisk.textContent = monthTotal > 50000 ? 'High' : (monthTotal > 20000 ? 'Medium' : 'Low');

      if (expenseChart) {
        const monthExpenses = state.expenses.filter(exp => exp.date.startsWith(monthKey));
        const byCat = {};
        monthExpenses.forEach(exp => {
          byCat[exp.category] = (byCat[exp.category] || 0) + exp.amount;
        });
        const entries = Object.entries(byCat).sort((a, b) => b[1] - a[1]);
        if (!entries.length) {
          expenseChart.innerHTML = '<div class="empty-state">No chart data yet.</div>';
        } else {
          const max = Math.max(...entries.map(e => e[1]));
          expenseChart.innerHTML = entries.map(([cat, amt]) => `
            <div class="chart-row">
              <strong>${cat}</strong>
              <div class="chart-bar" style="width:${Math.max(6, (amt / max) * 100)}%;"></div>
              <strong>₹${fmt.format(amt)}</strong>
            </div>
          `).join('');
        }
      }
    }

    if (expenseForm) {
      expenseForm.expenseDate.value = new Date().toISOString().slice(0, 10);
      expenseForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = new FormData(expenseForm);
        const name = data.get('expenseName').trim();
        const amount = Number(data.get('expenseAmount'));
        const category = data.get('expenseCategory');
        const date = data.get('expenseDate') || new Date().toISOString().slice(0, 10);
        const notes = data.get('expenseNotes') || '';
        if (!name || !amount) return;
        state.expenses.push({ name, amount, category, date, notes });
        saveState();
        renderExpenses();
        expenseForm.reset();
        expenseForm.expenseDate.value = new Date().toISOString().slice(0, 10);
      });
    }

    if (receiptUpload && receiptStatus) {
      receiptUpload.addEventListener('change', () => {
        const file = receiptUpload.files?.[0];
        if (!file) return;
        lastReceiptName = file.name || '';
        receiptStatus.textContent = `Receipt loaded: ${file.name}. Ready to auto‑fill.`;
      });
    }

    if (receiptFill && expenseForm) {
      receiptFill.addEventListener('click', () => {
        if (receiptStatus) receiptStatus.textContent = 'Auto‑fill running (demo)...';
        if (!lastReceiptName) {
          if (receiptStatus) receiptStatus.textContent = 'No receipt selected. Upload a file first.';
          return;
        }
        const amountFromName = (lastReceiptName.match(/(\d{2,6})/) || [])[1];
        const today = new Date().toISOString().slice(0, 10);
        expenseForm.expenseName.value = expenseForm.expenseName.value || 'Receipt expense';
        expenseForm.expenseAmount.value = expenseForm.expenseAmount.value || (amountFromName ? amountFromName : '1500');
        expenseForm.expenseCategory.value = expenseForm.expenseCategory.value || 'Supplies';
        expenseForm.expenseDate.value = expenseForm.expenseDate.value || today;
        expenseForm.expenseNotes.value = expenseForm.expenseNotes.value || 'Auto-filled from receipt (demo)';
        if (receiptStatus) receiptStatus.textContent = 'Receipt fields auto‑filled (demo).';
      });
    }

    if (expenseAiTag && expenseForm) {
      expenseAiTag.addEventListener('click', () => {
        const name = expenseForm.expenseName.value.toLowerCase();
        let cat = 'Other';
        if (name.includes('rent')) cat = 'Rent';
        else if (name.includes('travel') || name.includes('taxi')) cat = 'Travel';
        else if (name.includes('ad') || name.includes('marketing')) cat = 'Ads';
        else if (name.includes('bill') || name.includes('electric') || name.includes('wifi')) cat = 'Utilities';
        else if (name.includes('salary') || name.includes('payroll')) cat = 'Salaries';
        else if (name.includes('suppl') || name.includes('stationery')) cat = 'Supplies';
        expenseForm.expenseCategory.value = cat;
      });
    }

    if (exportExpensesBtn) {
      exportExpensesBtn.addEventListener('click', () => {
        const headers = ['Name', 'Amount', 'Category', 'Date', 'Notes'];
        const rows = state.expenses.map(e => [e.name, e.amount, e.category, e.date, e.notes]);
        const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Metrox Taxdesk_expenses.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    const purchaseForm = document.getElementById('purchase-form');
    const purchaseList = document.getElementById('purchase-list');
    const exportPurchasesBtn = document.getElementById('export-purchases');

    function renderPurchases() {
      if (!purchaseList) return;
      if (!state.purchases.length) {
        purchaseList.innerHTML = '<div class="empty-state">No purchases yet.</div>';
        return;
      }
      purchaseList.innerHTML = state.purchases.slice().reverse().map(p => `
        <div class="list-item" data-purchase-id="${p.id}">
          <div>
            <strong>${p.supplier}</strong><br/>
            <span class="muted">${p.item} • ${p.taxType} • ${p.date} • ${p.billNo || 'No ref'}</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <strong>₹${fmt.format(p.total)}</strong>
            <button class="btn" data-edit-purchase="${p.id}">Edit</button>
            <button class="btn ghost" data-delete-purchase="${p.id}">Delete</button>
          </div>
        </div>
      `).join('');

      purchaseList.querySelectorAll('[data-edit-purchase]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.editPurchase;
          const purchase = state.purchases.find(p => p.id === id);
          if (!purchase || !purchaseForm) return;
          purchaseForm.dataset.editing = id;
          purchaseForm.supplierName.value = purchase.supplier;
          purchaseForm.purchaseType.value = purchase.purchaseType;
          purchaseForm.purchaseSupply.value = purchase.supply;
          purchaseForm.purchaseGstRate.value = purchase.rate;
          purchaseForm.purchaseItem.value = purchase.item;
          purchaseForm.purchaseAmount.value = purchase.amount;
          purchaseForm.purchaseBillNo.value = purchase.billNo || '';
          purchaseForm.purchaseDate.value = purchase.date || '';
          purchaseForm.querySelector('button[type=\"submit\"]').textContent = 'Update purchase';
          purchaseForm.scrollIntoView({ behavior: 'smooth' });
        });
      });

      purchaseList.querySelectorAll('[data-delete-purchase]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.deletePurchase;
          if (!confirm('Delete this purchase entry?')) return;
          state.purchases = state.purchases.filter(p => p.id !== id);
          saveState();
          renderPurchases();
          updateDashboard();
          updateGstReport();
        });
      });
    }

    if (purchaseForm) {
      purchaseForm.purchaseDate.value = new Date().toISOString().slice(0, 10);
      purchaseForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = new FormData(purchaseForm);
        const supplier = data.get('supplierName').trim();
        const purchaseType = data.get('purchaseType');
        const supply = data.get('purchaseSupply');
        const rate = Number(data.get('purchaseGstRate'));
        const item = data.get('purchaseItem').trim() || 'Purchase';
        const amount = Number(data.get('purchaseAmount')) || 0;
        const billNo = data.get('purchaseBillNo').trim();
        const date = data.get('purchaseDate') || new Date().toISOString().slice(0, 10);
        if (!supplier || amount <= 0) return;
        const tax = amount * (rate / 100);
        const taxType = rate === 0 ? 'NONE' : (supply === 'inter' ? 'IGST' : 'CGST_SGST');
        const inputCgst = taxType === 'CGST_SGST' ? tax / 2 : 0;
        const inputSgst = taxType === 'CGST_SGST' ? tax / 2 : 0;
        const inputIgst = taxType === 'IGST' ? tax : 0;
        const total = amount + tax;
        const payload = {
          id: purchaseForm.dataset.editing || `PUR-${Date.now()}`,
          supplier,
          purchaseType,
          supply,
          rate,
          item,
          amount,
          inputCgst,
          inputSgst,
          inputIgst,
          total,
          taxType,
          billNo,
          date
        };
        if (purchaseForm.dataset.editing) {
          const idx = state.purchases.findIndex(p => p.id === purchaseForm.dataset.editing);
          if (idx !== -1) state.purchases[idx] = payload;
          delete purchaseForm.dataset.editing;
          purchaseForm.querySelector('button[type=\"submit\"]').textContent = 'Add purchase';
        } else {
          state.purchases.push(payload);
        }
        saveState();
        renderPurchases();
        updateDashboard();
        updateGstReport();
        purchaseForm.reset();
        purchaseForm.purchaseDate.value = new Date().toISOString().slice(0, 10);
      });
    }

    if (exportPurchasesBtn) {
      exportPurchasesBtn.addEventListener('click', () => {
        const headers = ['Supplier', 'Type', 'Item', 'Amount', 'TaxType', 'IGST', 'CGST', 'SGST', 'Total', 'Date', 'BillNo'];
        const rows = state.purchases.map(p => [
          p.supplier, p.purchaseType, p.item, p.amount, p.taxType, p.inputIgst, p.inputCgst, p.inputSgst, p.total, p.date, p.billNo || ''
        ]);
        const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Metrox Taxdesk_purchases.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    const addCustomerBtn = document.getElementById('add-customer-btn');
    const addCustomerForm = document.getElementById('add-customer-form');
    const addCustomerSave = document.getElementById('save-new-customer');
    const addCustomerCancel = document.getElementById('cancel-new-customer');
    if (addCustomerBtn && addCustomerForm) {
      addCustomerBtn.addEventListener('click', () => {
        addCustomerForm.style.display = addCustomerForm.style.display === 'none' ? 'grid' : 'none';
      });
    }
    if (addCustomerCancel && addCustomerForm) {
      addCustomerCancel.addEventListener('click', (e) => {
        e.preventDefault();
        addCustomerForm.style.display = 'none';
      });
    }
    if (addCustomerSave) {
      addCustomerSave.addEventListener('click', (e) => {
        e.preventDefault();
        const name = document.getElementById('new-cust-name').value.trim();
        if (!name) {
          alert('Customer name is required.');
          return;
        }
        if (state.customers[name] && !confirm('Customer already exists. Update details?')) {
          return;
        }
        state.customers[name] = {
          name,
          gstin: document.getElementById('new-cust-gstin').value.trim(),
          phone: document.getElementById('new-cust-phone').value.trim(),
          email: document.getElementById('new-cust-email').value.trim(),
          address: document.getElementById('new-cust-address').value.trim(),
          state: document.getElementById('new-cust-state').value.trim(),
          stateCode: gstStateCodes[document.getElementById('new-cust-state').value.trim()] || ''
        };
        saveState();
        renderCustomers();
        populateCustomerSelect();
        renderCustomerDetail(name);
        addCustomerForm.style.display = 'none';
        document.getElementById('new-cust-name').value = '';
        document.getElementById('new-cust-gstin').value = '';
        document.getElementById('new-cust-phone').value = '';
        document.getElementById('new-cust-email').value = '';
        document.getElementById('new-cust-address').value = '';
        document.getElementById('new-cust-state').value = '';
      });
    }

    const lineItemsBody = document.getElementById('line-items');
    const addLineItemBtn = document.getElementById('add-line-item');
    function initLineItems() {
      if (!lineItemsBody) return;
      if (!lineItemsBody.children.length) {
        lineItemsBody.appendChild(createLineItemRow({ description: 'Service', qty: 1, price: 0 }));
      }
      updateLineTotals();
    }
    if (lineItemsBody && addLineItemBtn) {
      addLineItemBtn.addEventListener('click', () => {
        lineItemsBody.appendChild(createLineItemRow());
        updateLineTotals();
      });
      initLineItems();
    }
    window.addLineItem = () => {
      if (!lineItemsBody) return;
      lineItemsBody.appendChild(createLineItemRow());
      updateLineTotals();
    };
    window.addEventListener('load', initLineItems);

    const customerSelect = document.getElementById('customer-select');
    if (customerSelect) {
      customerSelect.addEventListener('change', (e) => {
        if (e.target.value) applyCustomerProfile(e.target.value);
      });
    }

    const customerStateSelect = document.getElementById('customer-state');

    const aiCommand = document.getElementById('ai-command');
    const parseCommandBtn = document.getElementById('parse-command');
    const sampleCommandBtn = document.getElementById('sample-command');
    const aiMicBtn = document.getElementById('ai-mic-btn');
    const aiStopBtn = document.getElementById('ai-stop-btn');
    const aiStatus = document.getElementById('ai-status');
    const aiChat = document.getElementById('ai-chat');
    const aiJson = document.getElementById('ai-json');
    if (sampleCommandBtn && aiCommand) {
      sampleCommandBtn.addEventListener('click', () => {
        aiCommand.value = 'Create bill for Rahul Traders, ₹5000, GST 18%, Service';
      });
    }

    function parseInvoiceCommand(text) {
      const cmd = text || '';
      const amountMatch = cmd.match(/₹\s?([\d,]+(?:\.\d+)?)/i) || cmd.match(/(\d+(?:\.\d+)?)\s*(?:rs|rupees|inr)/i);
      const gstMatch = cmd.match(/gst\s?(\d{1,2})/i) || cmd.match(/(\d{1,2})\s*%/i);
      const nameMatch = cmd.match(/for\s+([^,]+)/i);
      const itemMatch = cmd.match(/,\s*([^,]+)$/i);
      const amount = amountMatch ? Number(amountMatch[1].replace(/,/g, '')) : 0;
      const rate = gstMatch ? Number(gstMatch[1]) : Number(state.company.defaultSlab || 18);
      const customer = nameMatch ? nameMatch[1].trim() : 'Walk-in Customer';
      const item = itemMatch ? itemMatch[1].trim() : 'Service';
      return { amount, rate, customer, item };
    }

    if (parseCommandBtn && aiCommand) {
      parseCommandBtn.addEventListener('click', () => {
        runAiCommand(aiCommand.value.trim());
      });
    }

    function buildAiJson(text) {
      const lower = text.toLowerCase();
      const isInvoice = /invoice|bill|gst bill|gst invoice/.test(lower);
      const isPurchase = /purchase|kharida|maal|buy|bought/.test(lower);
      const isExpense = /expense|kharcha|rent|fuel|ads|travel|bill payment|electric/.test(lower);
      let intent = 'unknown';
      if (isPurchase) intent = 'add_purchase';
      else if (isExpense) intent = 'add_expense';
      else if (isInvoice) intent = 'create_invoice';

      const amountMatch = text.match(/₹\s?([\d,]+(?:\.\d+)?)/i) || text.match(/(\d+(?:\.\d+)?)\s*(?:rs|rupees|inr)/i);
      const gstMatch = text.match(/gst\s?(\d{1,2})/i) || text.match(/(\d{1,2})\s*%/i);
      const nameMatch = text.match(/for\s+([^,]+)/i);
      const supplierMatch = text.match(/from\s+([^,]+)/i) || text.match(/se\s+([^,]+)/i);
      const amount = amountMatch ? Number(amountMatch[1].replace(/,/g, '')) : 0;
      const gst = gstMatch ? Number(gstMatch[1]) : 0;
      const gstValid = [0, 5, 12, 18, 28].includes(gst);

      const errors = [];
      if (intent === 'create_invoice') {
        if (!nameMatch) errors.push('Missing customer name.');
        if (!amount || amount <= 0) errors.push('Missing or invalid amount.');
        if (gstMatch && !gstValid) errors.push('Invalid GST slab.');
        if (gst > 0 && !/inter|intra|state/.test(lower)) errors.push('Missing place of supply.');
      }
      if (intent === 'add_purchase') {
        if (!supplierMatch) errors.push('Missing supplier name.');
        if (!amount || amount <= 0) errors.push('Missing or invalid amount.');
        if (gstMatch && !gstValid) errors.push('Invalid GST slab.');
        if (gst > 0 && !/inter|intra|state/.test(lower)) errors.push('Missing place of supply.');
      }
      if (intent === 'add_expense') {
        if (!amount || amount <= 0) errors.push('Missing or invalid amount.');
        if (gstMatch && !gstValid) errors.push('Invalid GST slab.');
      }

      if (errors.length) {
        return { is_valid: false, errors };
      }

      if (intent === 'create_invoice') {
        const taxType = gst === 0 ? 'NONE' : (lower.includes('inter') ? 'IGST' : 'CGST_SGST');
        const subtotal = Number(amount.toFixed(2));
        const totalTax = Number((subtotal * (gst / 100)).toFixed(2));
        const cgst = taxType === 'CGST_SGST' ? Number((totalTax / 2).toFixed(2)) : 0;
        const sgst = taxType === 'CGST_SGST' ? Number((totalTax / 2).toFixed(2)) : 0;
        const igst = taxType === 'IGST' ? totalTax : 0;
        return {
          intent,
          customer_name: nameMatch ? nameMatch[1].trim() : '',
          items: [{ description: 'Item', quantity: 1, unit_price: subtotal }],
          subtotal,
          gst_percentage: gst,
          tax_type: taxType,
          cgst,
          sgst,
          igst,
          total_tax: totalTax,
          grand_total: Number((subtotal + totalTax).toFixed(2)),
          place_of_supply: lower.includes('inter') ? 'Inter-state' : (lower.includes('intra') ? 'Intra-state' : '')
        };
      }

      if (intent === 'add_purchase') {
        const taxType = gst === 0 ? 'NONE' : (lower.includes('inter') ? 'IGST' : 'CGST_SGST');
        const subtotal = Number(amount.toFixed(2));
        const totalTax = Number((subtotal * (gst / 100)).toFixed(2));
        const inputCgst = taxType === 'CGST_SGST' ? Number((totalTax / 2).toFixed(2)) : 0;
        const inputSgst = taxType === 'CGST_SGST' ? Number((totalTax / 2).toFixed(2)) : 0;
        const inputIgst = taxType === 'IGST' ? totalTax : 0;
        return {
          intent,
          supplier_name: supplierMatch ? supplierMatch[1].trim() : '',
          items: [{ description: 'Item', quantity: 1, unit_price: subtotal }],
          subtotal,
          gst_percentage: gst,
          purchase_type: /service|services/.test(lower) ? 'services' : 'goods',
          tax_type: taxType,
          input_cgst: inputCgst,
          input_sgst: inputSgst,
          input_igst: inputIgst,
          total_input_tax: totalTax,
          grand_total: Number((subtotal + totalTax).toFixed(2)),
          place_of_supply: lower.includes('inter') ? 'Inter-state' : (lower.includes('intra') ? 'Intra-state' : '')
        };
      }

      if (intent === 'add_expense') {
        return {
          intent,
          expense_category: 'Other',
          description: text.trim(),
          amount: Number(amount.toFixed(2)),
          gst_percentage: gst
        };
      }

      return { intent: 'unknown' };
    }

    function runAiCommand(text) {
      const parsed = parseInvoiceCommand(text);
      document.getElementById('ai-customer').textContent = parsed.customer || '—';
      document.getElementById('ai-amount').textContent = parsed.amount ? `₹${fmt.format(parsed.amount)}` : '—';
      document.getElementById('ai-gst').textContent = `${parsed.rate || 0}%`;
      if (aiJson) aiJson.textContent = JSON.stringify(buildAiJson(text), null, 2);

      if (!parsed.amount) {
        if (aiStatus) aiStatus.textContent = 'I need an amount to generate the invoice.';
        return;
      }
      if (aiStatus) aiStatus.textContent = 'Invoice generated from voice command.';
      showScreen('invoices', 'Invoices');
      const form = document.getElementById('invoice-form');
      form.customer.value = parsed.customer;
      form.invoiceType.value = parsed.rate === 0 ? 'non-gst' : 'gst';
      form.gstRate.value = String(parsed.rate);
      lineItemsBody.innerHTML = '';
      lineItemsBody.appendChild(createLineItemRow({ description: parsed.item, qty: 1, price: parsed.amount }));
      updateLineTotals();
      refreshPreviewFromForm();
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function addChat(role, text) {
      if (!aiChat) return;
      const bubble = document.createElement('div');
      bubble.className = 'ai-bubble';
      bubble.innerHTML = `<strong>${role}:</strong> ${text}`;
      aiChat.prepend(bubble);
    }

    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-IN';
      utter.rate = 1;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function ruleReply(text) {
      const lower = text.toLowerCase();
      if (lower.includes('invoice') || lower.includes('bill') || lower.includes('gst')) {
        return 'Got it. I can generate the invoice now.';
      }
      if (lower.includes('help') || lower.includes('how')) {
        return 'Try: "Create bill for Rahul, 5000, GST 18%, Service".';
      }
      return 'I can create invoices. Say a customer name and amount.';
    }

    if (aiMicBtn) {
      let recognizer = null;
      aiMicBtn.addEventListener('click', () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          if (aiStatus) aiStatus.textContent = 'Voice not supported in this browser. Type instead.';
          return;
        }
        if (!recognizer) {
          recognizer = new SpeechRecognition();
          recognizer.lang = 'en-IN';
          recognizer.interimResults = false;
          recognizer.maxAlternatives = 1;
        }
        if (aiStatus) aiStatus.textContent = 'Listening...';
        aiMicBtn.textContent = 'Listening...';
        recognizer.start();

        recognizer.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          aiCommand.value = transcript;
          addChat('You', transcript);
          const reply = ruleReply(transcript);
          addChat('AI', reply);
          if (aiStatus) aiStatus.textContent = 'Heard: ' + transcript;
          speak(reply);
          runAiCommand(transcript);
        };

        recognizer.onerror = () => {
          if (aiStatus) aiStatus.textContent = 'Voice error. Please try again.';
        };

        recognizer.onend = () => {
          aiMicBtn.textContent = 'Start voice';
        };
      });

      if (aiStopBtn) {
        aiStopBtn.addEventListener('click', () => {
          if (recognizer) {
            recognizer.stop();
            if (aiStatus) aiStatus.textContent = 'Stopped.';
            aiMicBtn.textContent = 'Start voice';
          }
        });
      }
    }


    const sellerProfile = () => state.company;

    const gstStateCodes = {
      'Jammu & Kashmir': '01 JK',
      'Himachal Pradesh': '02 HP',
      'Punjab': '03 PB',
      'Chandigarh': '04 CH',
      'Uttarakhand': '05 UT',
      'Haryana': '06 HR',
      'Delhi': '07 DL',
      'Rajasthan': '08 RJ',
      'Uttar Pradesh': '09 UP',
      'Bihar': '10 BH',
      'Sikkim': '11 SK',
      'Arunachal Pradesh': '12 AR',
      'Nagaland': '13 NL',
      'Manipur': '14 MN',
      'Mizoram': '15 MI',
      'Tripura': '16 TR',
      'Meghalaya': '17 ME',
      'Assam': '18 AS',
      'West Bengal': '19 WB',
      'Jharkhand': '20 JH',
      'Odisha': '21 OR',
      'Chattisgarh': '22 CT',
      'Madhya Pradesh': '23 MP',
      'Gujarat': '24 GJ',
      'Daman & Diu': '25 DD',
      'Dadra & Nagar Haveli': '26 DN',
      'Maharashtra': '27 MH',
      'Andhra Pradesh (Before Division)': '28 AP',
      'Karnataka': '29 KA',
      'Goa': '30 GA',
      'Lakshadweep': '31 LD',
      'Kerala': '32 KL',
      'Tamil Nadu': '33 TN',
      'Puducherry': '34 PY',
      'Andaman & Nicobar Islands': '35 AN',
      'Telangana': '36 TL',
      'Andhra Pradesh (Newly Added)': '37 AD',
      'Ladakh': '38 LA'
    };

    function calcGST(amount, rate, supply, invoiceType) {
      const taxable = amount;
      if (invoiceType === 'non-gst' || rate === 0) {
        const rawTotal = taxable;
        const roundedTotal = Math.round(rawTotal);
        return {
          taxable,
          cgst: 0,
          sgst: 0,
          igst: 0,
          total: roundedTotal,
          roundOff: roundedTotal - rawTotal
        };
      }
      const tax = taxable * (rate / 100);
      if (supply === 'inter') {
        const rawTotal = taxable + tax;
        const roundedTotal = Math.round(rawTotal);
        return {
          taxable,
          cgst: 0,
          sgst: 0,
          igst: tax,
          total: roundedTotal,
          roundOff: roundedTotal - rawTotal
        };
      }
      const half = tax / 2;
      const rawTotal = taxable + tax;
      const roundedTotal = Math.round(rawTotal);
      return {
        taxable,
        cgst: half,
        sgst: half,
        igst: 0,
        total: roundedTotal,
        roundOff: roundedTotal - rawTotal
      };
    }

    function updateDashboard() {
      const monthSelect = document.getElementById('dashboard-month');
      const monthKey = monthSelect?.value || new Date().toISOString().slice(0, 7);
      const monthInvoices = state.invoices.filter(inv => (inv.createdAt || '').startsWith(monthKey));
      const monthPurchases = state.purchases.filter(p => (p.date || '').startsWith(monthKey));
      const totalSales = monthInvoices.reduce((sum, inv) => sum + inv.total, 0);
      const totalPurchases = monthPurchases.reduce((sum, p) => sum + p.total, 0);
      const gstPayable = monthInvoices.reduce((sum, inv) => sum + inv.cgst + inv.sgst + inv.igst, 0);
      const inputGst = monthPurchases.reduce((sum, p) => sum + p.inputCgst + p.inputSgst + p.inputIgst, 0);
      document.getElementById('stat-today').textContent = `₹${fmt.format(totalSales)}`;
      document.getElementById('stat-month').textContent = `₹${fmt.format(totalSales)}`;
      document.getElementById('stat-gst').textContent = `₹${fmt.format(Math.max(0, gstPayable - inputGst))}`;
      const gstTaxable = monthInvoices.reduce((sum, inv) => sum + inv.taxable, 0);
      const gstCount = monthInvoices.length;
      const gstTaxableEl = document.getElementById('gst-taxable');
      const gstTotalEl = document.getElementById('gst-total');
      const gstCountEl = document.getElementById('gst-count');
      if (gstTaxableEl) gstTaxableEl.textContent = `₹${fmt.format(gstTaxable)}`;
      if (gstTotalEl) gstTotalEl.textContent = `₹${fmt.format(gstPayable)}`;
      if (gstCountEl) gstCountEl.textContent = `${gstCount}`;

      const recent = document.getElementById('recent-invoices');
      if (!monthInvoices.length) {
        recent.textContent = 'No invoices yet.';
      } else {
        recent.innerHTML = monthInvoices.slice(-3).reverse().map(inv =>
          `<div class="row"><span>${inv.customer} • #${inv.id}</span><strong>₹${fmt.format(inv.total)}</strong></div>`
        ).join('');
      }

      const pending = document.getElementById('pending-payments');
      if (pending) {
        const pendingInvoices = monthInvoices.filter(inv => inv.status !== 'Paid').slice(0, 3);
        pending.innerHTML = pendingInvoices.length ? pendingInvoices.map(inv =>
          `<div class="row"><span>${inv.customer} • #${inv.id}</span><strong>₹${fmt.format(Math.max(0, inv.total - (inv.paidAmount || 0)))}</strong></div>`
        ).join('') : 'No pending payments.';
      }
    }

    function formatMonthLabel(ym) {
      const [y, m] = ym.split('-').map(Number);
      if (!y || !m) return ym;
      const date = new Date(y, m - 1, 1);
      return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    }

    function populateMonthSelects() {
      const months = new Set();
      state.invoices.forEach(inv => {
        if (inv.createdAt) months.add(inv.createdAt.slice(0, 7));
      });
      if (!months.size) months.add(new Date().toISOString().slice(0, 7));
      const sorted = Array.from(months).sort().reverse();
      const dashSel = document.getElementById('dashboard-month');
      const gstSel = document.getElementById('gst-month');
      if (dashSel) {
        dashSel.innerHTML = sorted.map(m => `<option value="${m}">${formatMonthLabel(m)}</option>`).join('');
        dashSel.value = sorted[0];
        dashSel.addEventListener('change', () => updateDashboard());
      }
      if (gstSel) {
        gstSel.innerHTML = sorted.map(m => `<option value="${m}">${formatMonthLabel(m)}</option>`).join('');
        gstSel.value = sorted[0];
        gstSel.addEventListener('change', () => updateGstReport());
      }
    }

    function updateGstReport() {
      const gstSel = document.getElementById('gst-month');
      const monthKey = gstSel?.value || new Date().toISOString().slice(0, 7);
      const monthInvoices = state.invoices.filter(inv => (inv.createdAt || '').startsWith(monthKey));
      const monthPurchases = state.purchases.filter(p => (p.date || '').startsWith(monthKey));
      const taxable = monthInvoices.reduce((sum, inv) => sum + inv.taxable, 0);
      const cgst = monthInvoices.reduce((sum, inv) => sum + inv.cgst, 0);
      const sgst = monthInvoices.reduce((sum, inv) => sum + inv.sgst, 0);
      const igst = monthInvoices.reduce((sum, inv) => sum + inv.igst, 0);
      const totalGst = cgst + sgst + igst;
      const count = monthInvoices.length;
      const igstShare = totalGst ? Math.round((igst / totalGst) * 100) : 0;
      const avgInv = count ? monthInvoices.reduce((sum, inv) => sum + inv.total, 0) / count : 0;
      const inCgst = monthPurchases.reduce((sum, p) => sum + p.inputCgst, 0);
      const inSgst = monthPurchases.reduce((sum, p) => sum + p.inputSgst, 0);
      const inIgst = monthPurchases.reduce((sum, p) => sum + p.inputIgst, 0);
      const netPayable = Math.max(0, totalGst - (inCgst + inSgst + inIgst));

      const gstTaxableEl = document.getElementById('gst-taxable');
      const gstTotalEl = document.getElementById('gst-total');
      const gstCountEl = document.getElementById('gst-count');
      const gstIgstEl = document.getElementById('gst-igst');
      const gstIntraEl = document.getElementById('gst-intra');
      const gstInterEl = document.getElementById('gst-inter');
      const gstAvgEl = document.getElementById('gst-avg');
      const gstInCgstEl = document.getElementById('gst-in-cgst');
      const gstInSgstEl = document.getElementById('gst-in-sgst');
      const gstInIgstEl = document.getElementById('gst-in-igst');
      const gstNetEl = document.getElementById('gst-net');
      if (gstTaxableEl) gstTaxableEl.textContent = `₹${fmt.format(taxable)}`;
      if (gstTotalEl) gstTotalEl.textContent = `₹${fmt.format(totalGst)}`;
      if (gstCountEl) gstCountEl.textContent = `${count}`;
      if (gstIgstEl) gstIgstEl.textContent = `${igstShare}%`;
      if (gstIntraEl) gstIntraEl.textContent = `₹${fmt.format(cgst + sgst)}`;
      if (gstInterEl) gstInterEl.textContent = `₹${fmt.format(igst)}`;
      if (gstAvgEl) gstAvgEl.textContent = `₹${fmt.format(avgInv)}`;
      if (gstInCgstEl) gstInCgstEl.textContent = `₹${fmt.format(inCgst)}`;
      if (gstInSgstEl) gstInSgstEl.textContent = `₹${fmt.format(inSgst)}`;
      if (gstInIgstEl) gstInIgstEl.textContent = `₹${fmt.format(inIgst)}`;
      if (gstNetEl) gstNetEl.textContent = `₹${fmt.format(netPayable)}`;
    }

    function updateInvoiceTable() {
      const tbody = document.querySelector('#invoice-table tbody');
      if (!state.invoices.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No invoices yet.</td></tr>';
        populateMonthSelects();
        updateGstReport();
        return;
      }
      tbody.innerHTML = state.invoices.map(inv => {
        const cgst = Number(inv.cgst) || 0;
        const sgst = Number(inv.sgst) || 0;
        const igst = Number(inv.igst) || 0;
        const gst = cgst + sgst + igst;
        let total = Number(inv.total);
        if (!Number.isFinite(total)) {
          const taxable = Number(inv.taxable) || 0;
          const roundOff = Number(inv.roundOff) || 0;
          total = taxable + gst + roundOff;
        }
        const statusClass = inv.status.toLowerCase();
        return `<tr>
          <td>#${inv.id}</td>
          <td>${inv.customer}</td>
          <td>${inv.type.toUpperCase()}</td>
          <td>₹${fmt.format(gst)}</td>
          <td>₹${fmt.format(total)}</td>
          <td><span class="status-pill status-${statusClass}">${inv.status}</span></td>
          <td>
            <button class="btn" data-pay="${inv.id}">Record</button>
            <button class="btn" data-export="${inv.id}">Export</button>
            <button class="btn" data-edit="${inv.id}">Edit</button>
            <button class="btn" data-delete="${inv.id}">Delete</button>
          </td>
        </tr>`;
      }).join('');

      tbody.querySelectorAll('[data-pay]').forEach(btn => {
        btn.addEventListener('click', () => openPaymentModal(btn.dataset.pay));
      });
      tbody.querySelectorAll('[data-export]').forEach(btn => {
        btn.addEventListener('click', () => exportInvoice(btn.dataset.export, false, true));
      });
      tbody.querySelectorAll('[data-edit]').forEach(btn => {
        btn.addEventListener('click', () => editInvoice(btn.dataset.edit));
      });
      tbody.querySelectorAll('[data-delete]').forEach(btn => {
        btn.addEventListener('click', () => deleteInvoice(btn.dataset.delete));
      });

      populateMonthSelects();
      updateGstReport();
    }

    function renderInvoiceDownloads() {
      const container = document.getElementById('invoice-downloads');
      if (!container) return;
      if (!state.invoices.length) {
        container.innerHTML = '<div class="empty-state">No invoices generated yet.</div>';
        return;
      }
      container.innerHTML = state.invoices.map(inv => `
        <div class="list-item">
          <div>
            <strong>#${inv.id} • ${inv.customer}</strong><br/>
            <span class="muted">Total ₹${fmt.format(inv.total)} • ${inv.status}</span>
          </div>
          <button class="btn" data-download="${inv.id}">Download PDF</button>
        </div>
      `).join('');

      container.querySelectorAll('[data-download]').forEach(btn => {
        btn.addEventListener('click', () => exportInvoice(btn.dataset.download, false, true));
      });
    }

    function getCustomerSummaries() {
      const map = new Map();
      Object.keys(state.customers || {}).forEach(name => {
        map.set(name, { name, billed: 0, paid: 0 });
      });
      state.invoices.forEach(inv => {
        const existing = map.get(inv.customer) || { name: inv.customer, billed: 0, paid: 0 };
        existing.billed += inv.total;
        existing.paid += inv.paidAmount || 0;
        map.set(inv.customer, existing);
      });
      return Array.from(map.values())
        .map(c => ({ ...c, due: Math.max(0, c.billed - c.paid) }))
        .sort((a, b) => b.billed - a.billed);
    }

    function renderCustomers() {
      const list = document.getElementById('customer-list');
      const search = document.getElementById('customer-search');
      if (!list || !search) return;

      const term = search.value.trim().toLowerCase();
      const customers = getCustomerSummaries()
        .filter(c => !state.customers[c.name]?.deleted)
        .filter(c => c.name.toLowerCase().includes(term));

      if (!customers.length) {
        list.innerHTML = '<div class="empty-state">No customers yet.</div>';
        document.getElementById('customer-detail').innerHTML = 'Select a customer to view ledger.';
        return;
      }

      list.innerHTML = customers.map(c => `
        <div class="list-item" data-customer="${c.name}">
          <div>
            <strong>${c.name}</strong><br/>
            <span class="muted">Billed ₹${fmt.format(c.billed)} • Due ₹${fmt.format(c.due)}</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" data-action="ledger" data-customer="${c.name}">Ledger</button>
            <button class="btn" data-action="edit" data-customer="${c.name}">Edit</button>
          </div>
        </div>
      `).join('');

      list.querySelectorAll('.list-item').forEach(item => {
        item.addEventListener('click', () => {
          const name = item.dataset.customer;
          renderCustomerDetail(name);
        });
      });

      list.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const name = btn.dataset.customer;
          renderCustomerDetail(name);
          if (btn.dataset.action === 'edit') {
            const editForm = document.getElementById('customer-edit-form');
            if (editForm) editForm.style.display = 'block';
          }
          if (btn.dataset.action === 'ledger') {
            const ledger = document.getElementById('customer-ledger');
            if (ledger) ledger.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });

      if (!document.getElementById('customer-detail').dataset.active) {
        renderCustomerDetail(customers[0].name);
      }
    }

    function renderDeletedCustomers() {
      const container = document.getElementById('deleted-customers');
      if (!container) return;
      const deleted = Object.keys(state.customers).filter(name => state.customers[name]?.deleted);
      if (!deleted.length) {
        container.innerHTML = '<div class="empty-state">No deleted customers.</div>';
        return;
      }
      container.innerHTML = deleted.map(name => `
        <div class="list-item" data-restore="${name}">
          <div>
            <strong>${name}</strong><br/>
            <span class="muted">Soft deleted</span>
          </div>
          <button class="btn" data-restore-btn="${name}">Restore</button>
        </div>
      `).join('');

      container.querySelectorAll('[data-restore-btn]').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.dataset.restoreBtn;
          if (!state.customers[name]) return;
          state.customers[name].deleted = false;
          saveState();
          renderCustomers();
          populateCustomerSelect();
          renderDeletedCustomers();
        });
      });
    }

    function populateCustomerSelect() {
      const select = document.getElementById('customer-select');
      if (!select) return;
      const current = select.value;
      const names = Object.keys(state.customers)
        .filter(name => !state.customers[name]?.deleted)
        .sort();
      select.innerHTML = '<option value="">New customer</option>' +
        names.map(name => `<option value="${name}">${name}</option>`).join('');
      select.value = current;
    }

    function applyCustomerProfile(name) {
      const profile = state.customers[name];
      if (!profile) return;
      const form = document.getElementById('invoice-form');
      form.customer.value = profile.name || name;
      form.customerGstin.value = profile.gstin || '';
      form.customerPhone.value = profile.phone || '';
      form.customerEmail.value = profile.email || '';
      form.customerAddress.value = profile.address || '';
      if (profile.state) {
        form.customerState.value = profile.state;
      }
    }

    function renderCustomerDetail(name) {
      const detail = document.getElementById('customer-detail');
      const invoices = state.invoices.filter(inv => inv.customer === name);
      const totalBilled = invoices.reduce((sum, inv) => sum + inv.total, 0);
      const totalPaid = invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0);
      const totalDue = Math.max(0, totalBilled - totalPaid);
      const payments = state.payments.filter(p => p.customer === name);
      const profile = state.customers[name] || {};

      detail.dataset.active = name;
      detail.innerHTML = `
        <h5>${name}</h5>
        <div class="muted" style="margin-top:6px;">
          GSTIN: ${profile.gstin || '—'}<br/>
          Phone: ${profile.phone || '—'} • Email: ${profile.email || '—'}<br/>
          Address: ${profile.address || '—'}
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="edit-customer-btn">Edit customer</button>
          <button class="btn" id="view-ledger-btn">View ledger</button>
          <button class="btn ghost" id="delete-customer-btn">Delete customer</button>
        </div>
        <div class="summary" style="margin-top:12px;">
          <div class="row"><span>Total billed</span><strong>₹${fmt.format(totalBilled)}</strong></div>
          <div class="row"><span>Total paid</span><strong>₹${fmt.format(totalPaid)}</strong></div>
          <div class="row"><span>Total due</span><strong>₹${fmt.format(totalDue)}</strong></div>
        </div>
        <div id="customer-edit-form" style="display:none;margin-top:12px;">
          <div class="summary">
            <div class="row"><span>Name</span><input class="btn" style="border-radius:8px;" id="cust-name" value="${profile.name || name}" /></div>
            <div class="row"><span>GSTIN</span><input class="btn" style="border-radius:8px;" id="cust-gstin" value="${profile.gstin || ''}" /></div>
            <div class="row"><span>Phone</span><input class="btn" style="border-radius:8px;" id="cust-phone" value="${profile.phone || ''}" /></div>
            <div class="row"><span>Email</span><input class="btn" style="border-radius:8px;" id="cust-email" value="${profile.email || ''}" /></div>
            <div class="row"><span>Address</span><input class="btn" style="border-radius:8px;" id="cust-address" value="${profile.address || ''}" /></div>
            <div class="row"><span>State</span><input class="btn" style="border-radius:8px;" id="cust-state" value="${profile.state || ''}" /></div>
          </div>
          <div style="margin-top:8px;">
            <button class="btn primary" id="save-customer-btn">Save</button>
            <button class="btn" id="cancel-customer-btn">Cancel</button>
          </div>
        </div>
        <div id="customer-ledger" style="margin-top:16px;">
          <strong>Invoices</strong>
          <div style="margin-top:8px;">
            ${invoices.length ? `
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Invoice</th>
                    <th>Total</th>
                    <th>Paid</th>
                    <th>Due</th>
                    <th>Status</th>
                    <th>Last payment</th>
                  </tr>
                </thead>
                <tbody>
                  ${invoices.map(inv => {
                    const invPayments = payments.filter(p => p.invoiceId === inv.id);
                    const lastPay = invPayments.length ? invPayments[invPayments.length - 1] : null;
                    const lastDate = lastPay ? (lastPay.iso ? new Date(lastPay.iso).toLocaleDateString('en-IN') : lastPay.date) : '—';
                    return `
                      <tr>
                        <td>#${inv.id}</td>
                        <td>₹${fmt.format(inv.total)}</td>
                        <td>₹${fmt.format(inv.paidAmount || 0)}</td>
                        <td>₹${fmt.format(Math.max(0, inv.total - (inv.paidAmount || 0)))}</td>
                        <td>${inv.status}</td>
                        <td>${lastDate}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            ` : '<div class="empty-state">No invoices for this customer.</div>'}
          </div>
        </div>
        <div style="margin-top:16px;">
          <strong>Payments</strong>
          <div class="payment-list">
            ${payments.length ? payments.map(p => `
              <div class="payment-item">
                <span>${p.iso ? new Date(p.iso).toLocaleDateString('en-IN') : p.date}</span>
                <strong>₹${fmt.format(p.amount)}</strong>
              </div>
            `).join('') : '<div class="empty-state">No payments recorded.</div>'}
          </div>
        </div>
      `;

      const editBtn = document.getElementById('edit-customer-btn');
      const ledgerBtn = document.getElementById('view-ledger-btn');
      const deleteBtn = document.getElementById('delete-customer-btn');
      const editForm = document.getElementById('customer-edit-form');
      const cancelBtn = document.getElementById('cancel-customer-btn');
      const saveBtn = document.getElementById('save-customer-btn');
      if (editBtn && editForm) {
        editBtn.addEventListener('click', () => {
          editForm.style.display = 'block';
        });
      }
      if (ledgerBtn) {
        ledgerBtn.addEventListener('click', () => {
          const ledger = document.getElementById('customer-ledger');
          if (ledger) ledger.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      }
      if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
      const invoices = state.invoices.filter(inv => inv.customer === name);
      const warning = invoices.length
            ? `This customer has ${invoices.length} invoices. Soft delete will hide the customer but keep invoices. Continue?`
            : 'Soft delete this customer?';
      if (!confirm(warning)) return;
      if (!state.customers[name]) return;
      state.customers[name].deleted = true;
      updateInvoiceTable();
      updateDashboard();
      renderCustomers();
      renderInvoiceDownloads();
      saveState();
        });
      }
      if (cancelBtn && editForm) {
        cancelBtn.addEventListener('click', () => {
          editForm.style.display = 'none';
        });
      }
      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          const newName = document.getElementById('cust-name').value.trim() || name;
          const updated = {
            name: newName,
            gstin: document.getElementById('cust-gstin').value.trim(),
            phone: document.getElementById('cust-phone').value.trim(),
            email: document.getElementById('cust-email').value.trim(),
            address: document.getElementById('cust-address').value.trim(),
            state: document.getElementById('cust-state').value.trim(),
            stateCode: gstStateCodes[document.getElementById('cust-state').value.trim()] || profile.stateCode || ''
          };
          // Update customer key if name changed
          if (newName !== name) {
            state.customers[newName] = updated;
            delete state.customers[name];
            state.invoices.forEach(inv => {
              if (inv.customer === name) inv.customer = newName;
            });
            state.payments.forEach(p => {
              if (p.customer === name) p.customer = newName;
            });
          } else {
            state.customers[name] = updated;
          }
          saveState();
          renderCustomers();
          renderCustomerDetail(newName);
        });
      }
    }

    function setInvoiceStatus(inv) {
      if ((inv.paidAmount || 0) >= inv.total) {
        inv.status = 'Paid';
      } else if ((inv.paidAmount || 0) > 0) {
        inv.status = 'Partial';
      } else {
        inv.status = 'Pending';
      }
    }

    function createLineItemRow(data = {}) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input name="desc" value="${data.description || ''}" placeholder="Item or service" /></td>
        <td><input name="hsn" value="${data.hsn || ''}" placeholder="HSN" /></td>
        <td><input name="sac" value="${data.sac || ''}" placeholder="SAC" /></td>
        <td><input name="qty" type="number" min="1" step="1" value="${data.qty || 1}" /></td>
        <td><input name="price" type="number" min="0" step="0.01" value="${data.price || 0}" /></td>
        <td class="line-total">₹0</td>
        <td><button type="button" class="btn ghost remove-line">Remove</button></td>
      `;
      wireLineItemRow(row);
      return row;
    }
    window.createLineItemRow = createLineItemRow;

    function wireLineItemRow(row) {
      if (!row) return;
      const removeBtn = row.querySelector('.remove-line');
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          row.remove();
          updateLineTotals();
        });
      }
      row.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', updateLineTotals);
      });
    }

    function updateLineTotals() {
      const rows = Array.from(document.querySelectorAll('#line-items tr'));
      rows.forEach(row => {
        const qty = Number(row.querySelector('[name="qty"]').value) || 0;
        const price = Number(row.querySelector('[name="price"]').value) || 0;
        const total = (qty || 1) * price;
        row.querySelector('.line-total').textContent = `₹${fmt.format(total)}`;
      });
      if (typeof refreshPreviewFromForm === 'function') refreshPreviewFromForm();
    }
    window.updateLineTotals = updateLineTotals;

    function collectLineItems() {
      return Array.from(document.querySelectorAll('#line-items tr')).map(row => {
        const qty = Number(row.querySelector('[name="qty"]').value) || 0;
        const price = Number(row.querySelector('[name="price"]').value) || 0;
        const desc = row.querySelector('[name="desc"]').value.trim();
        return {
          description: desc || (qty || price ? 'Item' : ''),
          hsn: row.querySelector('[name="hsn"]').value.trim(),
          sac: row.querySelector('[name="sac"]').value.trim(),
          qty: qty || 1,
          price,
          total: (qty || 1) * price
        };
      }).filter(item => item.description);
    }

    function refreshPreviewFromForm() {
      const form = document.getElementById('invoice-form');
      if (!form) return;
      const invoiceType = form.invoiceType.value;
      const supply = form.supply.value;
      const rate = Number(form.gstRate.value);
      const items = collectLineItems();
      const taxable = items.reduce((sum, item) => sum + item.total, 0);
      const calc = calcGST(taxable, rate, supply, invoiceType);
      updatePreview({
        id: document.getElementById('prev-id').textContent,
        customer: form.customer.value || '—',
        taxable: calc.taxable,
        cgst: calc.cgst,
        sgst: calc.sgst,
        igst: calc.igst,
        total: calc.total,
        roundOff: calc.roundOff,
        type: invoiceType,
        rate,
        supply
      });
    }

    const STORAGE_KEY = 'metrox_taxdesk_demo_state';
    const BACKUP_KEY = 'metrox_taxdesk_demo_state_backup';
    const REQUIRE_LOGIN_EVERY_SESSION = false;

    function saveState() {
      const payload = {
        auth: state.auth,
        users: state.users,
        invoices: state.invoices,
        invoiceCounter: state.invoiceCounter,
        payments: state.payments,
        expenses: state.expenses,
        purchases: state.purchases,
        customers: state.customers,
        company: state.company
      };
      const serialized = JSON.stringify(payload);
      localStorage.setItem(STORAGE_KEY, serialized);
      localStorage.setItem(BACKUP_KEY, serialized);
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const backup = localStorage.getItem(BACKUP_KEY);
        if (!backup) return;
        try {
          const data = JSON.parse(backup);
          state.invoices = Array.isArray(data.invoices) ? data.invoices : [];
          state.invoiceCounter = Number(data.invoiceCounter) || 2409;
          state.payments = Array.isArray(data.payments) ? data.payments : [];
          state.customers = data.customers || {};
          state.users = Array.isArray(data.users) && data.users.length ? data.users : state.users;
          state.auth = { ...state.auth, ...(data.auth || {}) };
          state.company = {
            ...state.company,
            ...(data.company || {}),
            bank: { ...state.company.bank, ...(data.company?.bank || {}) },
            theme: { ...state.company.theme, ...(data.company?.theme || {}) },
            invoiceNumber: { ...state.company.invoiceNumber, ...(data.company?.invoiceNumber || {}) }
          };
        } catch (err) {
          console.warn('Failed to load backup state', err);
        }
        return;
      }
      try {
        const data = JSON.parse(raw);
        state.auth = { ...state.auth, ...(data.auth || {}) };
        state.users = Array.isArray(data.users) && data.users.length ? data.users : state.users;
        state.invoices = Array.isArray(data.invoices) ? data.invoices : [];
        state.invoiceCounter = Number(data.invoiceCounter) || 2409;
        state.payments = Array.isArray(data.payments) ? data.payments : [];
        state.expenses = Array.isArray(data.expenses) ? data.expenses : [];
        state.purchases = Array.isArray(data.purchases) ? data.purchases : [];
        state.customers = data.customers || {};
        state.company = {
          ...state.company,
          ...(data.company || {}),
          bank: { ...state.company.bank, ...(data.company?.bank || {}) },
          theme: { ...state.company.theme, ...(data.company?.theme || {}) },
          invoiceNumber: { ...state.company.invoiceNumber, ...(data.company?.invoiceNumber || {}) }
        };
        if (!state.company.invoiceNumber.pad) {
          const nextStr = String(state.company.invoiceNumber.next || '001');
          state.company.invoiceNumber.pad = nextStr.length;
        }
        if (!state.company.invoiceNumber.start) {
          state.company.invoiceNumber.start = state.company.invoiceNumber.next || '001';
        }
        if (REQUIRE_LOGIN_EVERY_SESSION) {
          state.auth.verified = false;
        }
        state.invoices.forEach(setInvoiceStatus);
      } catch (err) {
        console.warn('Failed to load saved state', err);
      }
    }

    window.addEventListener('beforeunload', () => {
      saveState();
    });

    const paymentModal = document.getElementById('payment-modal');
    const paymentClose = document.getElementById('payment-close');
    const paymentSave = document.getElementById('payment-save');
    const paymentAmount = document.getElementById('payment-amount');
    let activeInvoiceId = null;

    function openPaymentModal(invoiceId) {
      const invoice = state.invoices.find(inv => inv.id === invoiceId);
      if (!invoice) return;
      activeInvoiceId = invoiceId;
      document.getElementById('payment-invoice').textContent = `${invoice.id} • ${invoice.customer}`;
      const due = Math.max(0, invoice.total - (invoice.paidAmount || 0));
      document.getElementById('payment-due').textContent = `₹${fmt.format(due)}`;
      paymentAmount.value = due.toFixed(2);
      paymentModal.classList.add('active');
    }

    paymentClose.addEventListener('click', () => paymentModal.classList.remove('active'));
    paymentModal.addEventListener('click', (e) => {
      if (e.target === paymentModal) paymentModal.classList.remove('active');
    });

    paymentSave.addEventListener('click', () => {
      const invoice = state.invoices.find(inv => inv.id === activeInvoiceId);
      if (!invoice) return;
      const amount = Number(paymentAmount.value) || 0;
      const due = Math.max(0, invoice.total - (invoice.paidAmount || 0));
      const applied = Math.min(amount, due);
      if (applied <= 0) return;
      invoice.paidAmount = (invoice.paidAmount || 0) + applied;
      setInvoiceStatus(invoice);
      state.payments.push({
        invoiceId: invoice.id,
        customer: invoice.customer,
        amount: applied,
        date: new Date().toLocaleDateString('en-IN')
      });
      updateInvoiceTable();
      updateDashboard();
      renderCustomers();
      renderInvoiceDownloads();
      saveState();
      paymentModal.classList.remove('active');
    });

    function exportInvoice(invoiceId, autoPrint = false, autoPdf = false) {
      const invoice = state.invoices.find(inv => inv.id === invoiceId);
      if (!invoice) return;
      const seller = sellerProfile();
      const payload = {
        id: invoice.id,
        date: invoice.createdAt || new Date().toISOString(),
        taxable: invoice.taxable,
        cgst: invoice.cgst,
        sgst: invoice.sgst,
        igst: invoice.igst,
        total: invoice.total,
        roundOff: invoice.roundOff || 0,
        notes: invoice.notes || '',
        items: invoice.items || [],
        seller: seller,
        customer: {
          name: invoice.customer,
          gstin: invoice.customerDetails?.gstin || '',
          phone: invoice.customerDetails?.phone || '',
          email: invoice.customerDetails?.email || '',
          address: invoice.customerDetails?.address || '',
          state: invoice.customerDetails?.state || '',
          stateCode: invoice.customerDetails?.stateCode || ''
        },
        theme: seller.theme || {},
        logo: seller.logo || '',
        signature: seller.signature || '',
        qr: seller.qr || '',
        footer: seller.footer || '',
        font: seller.font || 'Poppins',
        bank: seller.bank || {},
        template: seller.template || 'modern',
        watermarkPaid: seller.watermarkPaid,
        status: invoice.status,
        placeOfSupply: invoice.supply === 'inter' ? 'Inter-state' : 'Intra-state',
        invoiceType: invoice.type === 'gst' ? 'GST Invoice' : 'Non-GST Invoice'
      };
      localStorage.setItem('Metrox Taxdesk_export_invoice', JSON.stringify(payload));
      let url = 'invoice-template.html';
      if (autoPrint) url = 'invoice-template.html?auto=print';
      if (autoPdf) url = 'invoice-template.html?auto=pdf';
      window.open(url, '_blank');
    }

    function editInvoice(invoiceId) {
      const invoice = state.invoices.find(inv => inv.id === invoiceId);
      if (!invoice) return;
      document.querySelector('[data-screen="invoices"]').click();
      const form = document.getElementById('invoice-form');
      form.customer.value = invoice.customer;
      form.invoiceType.value = invoice.type;
      form.supply.value = invoice.supply;
      form.gstRate.value = invoice.rate;
      form.customerGstin.value = invoice.customerDetails?.gstin || '';
      form.customerPhone.value = invoice.customerDetails?.phone || '';
      form.customerEmail.value = invoice.customerDetails?.email || '';
      form.customerAddress.value = invoice.customerDetails?.address || '';
      form.notes.value = invoice.notes || '';

      lineItemsBody.innerHTML = '';
      (invoice.items || []).forEach(item => {
        lineItemsBody.appendChild(createLineItemRow(item));
      });
      if (!(invoice.items || []).length) {
        lineItemsBody.appendChild(createLineItemRow({ description: 'Service', qty: 1, price: 0 }));
      }
      updateLineTotals();

      form.dataset.editing = invoiceId;
      form.querySelector('button[type="submit"]').textContent = 'Update Invoice';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function deleteInvoice(invoiceId) {
      const index = state.invoices.findIndex(inv => inv.id === invoiceId);
      if (index === -1) return;
      if (!confirm('Delete this invoice? This cannot be undone.')) return;
      state.invoices.splice(index, 1);
      resequenceInvoices();
      updateInvoiceTable();
      updateDashboard();
      renderCustomers();
      renderInvoiceDownloads();
      saveState();
    }

    function resequenceInvoices() {
      const prefix = state.company.invoiceNumber?.prefix || 'EG-';
      const prefixWithSpace = prefix.endsWith(' ') ? prefix : `${prefix} `;
      const pad = state.company.invoiceNumber?.pad || 3;
      const startNum = parseInt(state.company.invoiceNumber?.start || state.company.invoiceNumber?.next || '1', 10);
      const base = startNum - 1;
      const idMap = new Map();
      state.invoices.forEach((inv, idx) => {
        const newId = `${prefixWithSpace}${String(base + idx + 1).padStart(pad, '0')}`;
        idMap.set(inv.id, newId);
        inv.id = newId;
      });
      state.company.invoiceNumber.next = String(base + state.invoices.length + 1).padStart(pad, '0');
      state.payments = state.payments.map(p => ({
        ...p,
        invoiceId: idMap.get(p.invoiceId) || p.invoiceId
      }));
    }

    const exportPdfBtn = document.getElementById('export-gst-pdf');
    if (exportPdfBtn) {
      exportPdfBtn.addEventListener('click', () => {
        const gstSel = document.getElementById('gst-month');
        const monthKey = gstSel?.value || new Date().toISOString().slice(0, 7);
        const monthInvoices = state.invoices.filter(inv => (inv.createdAt || '').startsWith(monthKey));
        const taxable = monthInvoices.reduce((sum, inv) => sum + inv.taxable, 0);
        const cgst = monthInvoices.reduce((sum, inv) => sum + inv.cgst, 0);
        const sgst = monthInvoices.reduce((sum, inv) => sum + inv.sgst, 0);
        const igst = monthInvoices.reduce((sum, inv) => sum + inv.igst, 0);
        const totalGst = cgst + sgst + igst;
        const payload = {
          month: monthKey,
          label: formatMonthLabel(monthKey),
          company: state.company,
          taxable,
          cgst,
          sgst,
          igst,
          totalGst,
          invoices: monthInvoices.map(inv => ({
            id: inv.id,
            date: inv.createdAt,
            customer: inv.customer,
            taxable: inv.taxable,
            cgst: inv.cgst,
            sgst: inv.sgst,
            igst: inv.igst,
            total: inv.total
          }))
        };
        localStorage.setItem('Metrox Taxdesk_gst_report', JSON.stringify(payload));
        window.open('gst-report.html?auto=print', '_blank');
      });
    }

    const exportExcelBtn = document.getElementById('export-gst-excel');
    if (exportExcelBtn) {
      exportExcelBtn.addEventListener('click', () => {
        const headers = ['Invoice ID', 'Date', 'Customer', 'Taxable', 'CGST', 'SGST', 'IGST', 'Total'];
        const rows = state.invoices.map(inv => [
          inv.id,
          new Date(inv.createdAt || Date.now()).toLocaleDateString('en-IN'),
          inv.customer,
          inv.taxable,
          inv.cgst,
          inv.sgst,
          inv.igst,
          inv.total
        ]);
        const csv = [headers, ...rows].map(row => row.join(',')).join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Metrox Taxdesk_gst_report.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function updatePreview(inv) {
      document.getElementById('prev-id').textContent = inv.id;
      document.getElementById('prev-customer').textContent = inv.customer;
      document.getElementById('prev-taxable').textContent = `₹${fmt.format(inv.taxable)}`;
      document.getElementById('prev-total').textContent = `₹${fmt.format(inv.total)}`;
      document.getElementById('prev-roundoff').textContent = `₹${fmt.format(inv.roundOff || 0)}`;
      const taxLabel = document.getElementById('prev-tax-label');
      const taxValue = document.getElementById('prev-tax');
      const breakup = document.getElementById('gst-breakup');

      if (inv.type === 'non-gst' || inv.rate === 0) {
        taxLabel.textContent = 'GST';
        taxValue.textContent = '₹0';
        breakup.style.display = 'none';
      } else if (inv.supply === 'inter') {
        taxLabel.textContent = 'IGST';
        taxValue.textContent = `₹${fmt.format(inv.igst)}`;
        breakup.style.display = 'none';
      } else {
        taxLabel.textContent = 'GST';
        taxValue.textContent = `₹${fmt.format(inv.cgst + inv.sgst)}`;
        breakup.style.display = 'grid';
        document.getElementById('prev-cgst').textContent = `₹${fmt.format(inv.cgst)}`;
        document.getElementById('prev-sgst').textContent = `₹${fmt.format(inv.sgst)}`;
        document.getElementById('prev-igst').textContent = '₹0';
      }
    }

    const form = document.getElementById('invoice-form');
    const generateBtn = document.getElementById('generate-invoice-btn');
    form.addEventListener('input', () => {
      refreshPreviewFromForm();
    });

    function handleGenerateInvoice() {
      if (!form) return;
      const data = new FormData(form);
      const customer = data.get('customer').trim();
      const invoiceType = data.get('invoiceType');
      const supply = data.get('supply');
      const rate = Number(data.get('gstRate'));
      const items = collectLineItems();
      if (!items.length) {
        alert('Please add at least one line item.');
        return;
      }
      const taxableTotal = items.reduce((sum, item) => sum + item.total, 0);

      const isEditing = !!form.dataset.editing;
      const prefix = state.company.invoiceNumber?.prefix || 'EG-';
      if (!state.company.invoiceNumber?.next) {
        state.company.invoiceNumber = { prefix, next: '001', pad: 3 };
      }
      const pad = state.company.invoiceNumber.pad || String(state.company.invoiceNumber.next).length;
      const nextNum = parseInt(state.company.invoiceNumber.next, 10) || 1;
      const formatted = String(nextNum).padStart(pad, '0');
      const prefixWithSpace = prefix.endsWith(' ') ? prefix : `${prefix} `;
      const id = isEditing ? form.dataset.editing : `${prefixWithSpace}${formatted}`;
      if (!isEditing) {
        state.company.invoiceNumber.next = String(nextNum + 1).padStart(pad, '0');
      }
      const calc = calcGST(taxableTotal, rate, supply, invoiceType);

      const invoice = {
        id,
        customer,
        customerDetails: {
          gstin: data.get('customerGstin'),
          phone: data.get('customerPhone'),
          email: data.get('customerEmail'),
          address: data.get('customerAddress'),
          state: data.get('customerState'),
          stateCode: gstStateCodes[data.get('customerState')] || ''
        },
        items,
        type: invoiceType,
        supply,
        rate,
        taxable: calc.taxable,
        cgst: calc.cgst,
        sgst: calc.sgst,
        igst: calc.igst,
        total: calc.total,
        roundOff: calc.roundOff,
        paidAmount: 0,
        createdAt: new Date().toISOString(),
        notes: data.get('notes') || ''
      };

      state.customers[customer] = {
        name: customer,
        gstin: data.get('customerGstin'),
        phone: data.get('customerPhone'),
        email: data.get('customerEmail'),
        address: data.get('customerAddress'),
        state: data.get('customerState'),
        stateCode: gstStateCodes[data.get('customerState')] || ''
      };

      setInvoiceStatus(invoice);
      if (isEditing) {
        const idx = state.invoices.findIndex(inv => inv.id === id);
        if (idx !== -1) {
          invoice.paidAmount = state.invoices[idx].paidAmount || 0;
          invoice.status = state.invoices[idx].status || invoice.status;
          state.invoices[idx] = invoice;
        }
      } else {
        state.invoices.push(invoice);
      }
      updatePreview(invoice);
      updateInvoiceTable();
      updateDashboard();
      renderCustomers();
      renderInvoiceDownloads();
      populateCustomerSelect();
      saveState();
      form.reset();
      form.querySelector('[name="gstRate"]').value = '18';
      delete form.dataset.editing;
      form.querySelector('button[type="submit"]').textContent = 'Generate Invoice';
      lineItemsBody.innerHTML = '';
      lineItemsBody.appendChild(createLineItemRow({ description: 'Service', qty: 1, price: 0 }));
      updateLineTotals();
    }

    if (generateBtn) {
      generateBtn.addEventListener('click', handleGenerateInvoice);
    }
    window.handleGenerateInvoice = handleGenerateInvoice;
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      handleGenerateInvoice();
    });

    loadState();
    updateDashboard();
    updateInvoiceTable();
    renderExpenses();
    renderPurchases();
    renderDeletedCustomers();
    renderCustomers();
    renderInvoiceDownloads();
    populateCustomerSelect();
    updateLineTotals();

    const settingsForm = document.getElementById('settings-form');
    if (settingsForm) {
      const applySettingsToForm = () => {
        settingsForm.companyName.value = state.company.name || '';
        settingsForm.companyGstin.value = state.company.gstin || '';
        settingsForm.companyEmail.value = state.company.email || '';
        settingsForm.companyPhone.value = state.company.phone || '';
        settingsForm.companyAddress.value = state.company.address || '';
        settingsForm.invoiceFooter.value = state.company.footer || '';
        settingsForm.invoiceFont.value = state.company.font || 'Poppins';
        settingsForm.invoiceStyle.value = state.company.template || 'modern';
        settingsForm.watermarkPaid.checked = !!state.company.watermarkPaid;
        settingsForm.invoicePrefix.value = state.company.invoiceNumber?.prefix || 'EG-';
        settingsForm.invoiceNext.value = state.company.invoiceNumber?.next || '001';
        settingsForm.bankName.value = state.company.bank?.name || '';
        settingsForm.bankAccount.value = state.company.bank?.account || '';
        settingsForm.bankIfsc.value = state.company.bank?.ifsc || '';
        settingsForm.bankBranch.value = state.company.bank?.branch || '';
        settingsForm.bankUpi.value = state.company.bank?.upi || '';
      };

      applySettingsToForm();

      settingsForm.addEventListener('submit', (e) => {
        e.preventDefault();
        state.company.name = settingsForm.companyName.value.trim() || state.company.name;
        state.company.gstin = settingsForm.companyGstin.value.trim();
        state.company.email = settingsForm.companyEmail.value.trim();
        state.company.phone = settingsForm.companyPhone.value.trim();
        state.company.address = settingsForm.companyAddress.value.trim();
        state.company.footer = settingsForm.invoiceFooter.value.trim();
        state.company.font = settingsForm.invoiceFont.value;
        state.company.template = settingsForm.invoiceStyle.value;
        state.company.watermarkPaid = settingsForm.watermarkPaid.checked;
        state.company.invoiceNumber.prefix = settingsForm.invoicePrefix.value.trim() || 'EG-';
        const nextRaw = settingsForm.invoiceNext.value.trim() || state.company.invoiceNumber.next || '001';
        state.company.invoiceNumber.next = nextRaw;
        state.company.invoiceNumber.start = nextRaw;
        state.company.invoiceNumber.pad = Math.max(1, nextRaw.length);
        state.company.bank.name = settingsForm.bankName.value.trim();
        state.company.bank.account = settingsForm.bankAccount.value.trim();
        state.company.bank.ifsc = settingsForm.bankIfsc.value.trim();
        state.company.bank.branch = settingsForm.bankBranch.value.trim();
        state.company.bank.upi = settingsForm.bankUpi.value.trim();
        saveState();
        alert('Settings saved. New invoices will use this branding.');
      });

      settingsForm.companyLogo.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          state.company.logo = reader.result;
          saveState();
          alert('Logo saved. It will appear on exported invoices.');
        };
        reader.readAsDataURL(file);
      });

      settingsForm.companySignature.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          state.company.signature = reader.result;
          saveState();
          alert('Signature saved. It will appear on exported invoices.');
        };
        reader.readAsDataURL(file);
      });

      settingsForm.companyQr.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          state.company.qr = reader.result;
          saveState();
          alert('QR code saved. It will appear on exported invoices.');
          refreshInvoicePreview();
        };
        reader.readAsDataURL(file);
      });

      settingsForm.addEventListener('input', () => {
        state.company.name = settingsForm.companyName.value.trim() || state.company.name;
        state.company.gstin = settingsForm.companyGstin.value.trim();
        state.company.email = settingsForm.companyEmail.value.trim();
        state.company.phone = settingsForm.companyPhone.value.trim();
        state.company.address = settingsForm.companyAddress.value.trim();
        state.company.footer = settingsForm.invoiceFooter.value.trim();
        state.company.font = settingsForm.invoiceFont.value;
        state.company.template = settingsForm.invoiceStyle.value;
        state.company.watermarkPaid = settingsForm.watermarkPaid.checked;
        state.company.bank.name = settingsForm.bankName.value.trim();
        state.company.bank.account = settingsForm.bankAccount.value.trim();
        state.company.bank.ifsc = settingsForm.bankIfsc.value.trim();
        state.company.bank.branch = settingsForm.bankBranch.value.trim();
        state.company.bank.upi = settingsForm.bankUpi.value.trim();
      });
    }
  </script>
</body>
</html>
